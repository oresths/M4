<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Pandora Head Sensors: LibMods/rt_CMSIS.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pandora Head Sensors
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('rt__CMSIS_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">LibMods/rt_CMSIS.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="rt__CMSIS_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*----------------------------------------------------------------------------</span>
<a name="l00002"></a>00002 <span class="comment"> *      RL-ARM - RTX</span>
<a name="l00003"></a>00003 <span class="comment"> *----------------------------------------------------------------------------</span>
<a name="l00004"></a>00004 <span class="comment"> *      Name:    rt_CMSIS.c</span>
<a name="l00005"></a>00005 <span class="comment"> *      Purpose: CMSIS RTOS API</span>
<a name="l00006"></a>00006 <span class="comment"> *      Rev.:    V4.60</span>
<a name="l00007"></a>00007 <span class="comment"> *----------------------------------------------------------------------------</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Copyright (c) 1999-2009 KEIL, 2009-2012 ARM Germany GmbH</span>
<a name="l00010"></a>00010 <span class="comment"> * All rights reserved.</span>
<a name="l00011"></a>00011 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00012"></a>00012 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00013"></a>00013 <span class="comment"> *  - Redistributions of source code must retain the above copyright</span>
<a name="l00014"></a>00014 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00015"></a>00015 <span class="comment"> *  - Redistributions in binary form must reproduce the above copyright</span>
<a name="l00016"></a>00016 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00017"></a>00017 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00018"></a>00018 <span class="comment"> *  - Neither the name of ARM  nor the names of its contributors may be used </span>
<a name="l00019"></a>00019 <span class="comment"> *    to endorse or promote products derived from this software without </span>
<a name="l00020"></a>00020 <span class="comment"> *    specific prior written permission.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="l00023"></a>00023 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="l00024"></a>00024 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00025"></a>00025 <span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL COPYRIGHT HOLDERS AND CONTRIBUTORS BE</span>
<a name="l00026"></a>00026 <span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00027"></a>00027 <span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
<a name="l00028"></a>00028 <span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
<a name="l00029"></a>00029 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
<a name="l00030"></a>00030 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) </span>
<a name="l00031"></a>00031 <span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00032"></a>00032 <span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00033"></a>00033 <span class="comment"> *---------------------------------------------------------------------------*/</span>
<a name="l00034"></a>00034 
<a name="l00043"></a><a class="code" href="rt__CMSIS_8c.html#a87c3b351c33a90de11a2f23e67867a8a">00043</a> <span class="preprocessor">#define __CMSIS_GENERIC</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="preprocessor">#if defined (__CORTEX_M4) || defined (__CORTEX_M4F)</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">  #include &quot;core_cm4.h&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#elif defined (__CORTEX_M3)</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">  #include &quot;core_cm3.h&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#elif defined (__CORTEX_M0)</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">  #include &quot;core_cm0.h&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#elif defined (__CORTEX_M0PLUS)</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">  #include &quot;core_cm0plus.h&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#else</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">  #error &quot;Missing __CORTEX_Mx definition&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;rt_TypeDef.h&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;RTX_Conf.h&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;rt_System.h&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;rt_Task.h&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;rt_Event.h&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;rt_List.h&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;rt_Time.h&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;rt_Mutex.h&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;rt_Semaphore.h&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;rt_Mailbox.h&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;rt_MemBox.h&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;rt_HAL_CM.h&quot;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="rt__CMSIS_8c.html#aa621b23ac2b3f89ac7322ee72df4bade">00070</a> <span class="preprocessor">#define os_thread_cb OS_TCB</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;cmsis_os.h&quot;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#if (osFeature_Signals != 16)</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#error Invalid &quot;osFeature_Signals&quot; value!</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#if (osFeature_Semaphore &gt; 65535)</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#error Invalid &quot;osFeature_Semaphore&quot; value!</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#if (osFeature_Wait != 0)</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#error osWait not supported!</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">// ==== Enumeration, structures, defines ====</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">// Service Calls defines</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="preprocessor">#if defined (__CC_ARM)          </span><span class="comment">/* ARM Compiler */</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="preprocessor">#define __NO_RETURN __declspec(noreturn)</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>
<a name="l00093"></a>00093 <span class="preprocessor">#define osEvent_type       osEvent</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_status ret</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_value  ret</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_msg    ret</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_mail   ret</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>
<a name="l00099"></a>00099 <span class="preprocessor">#define osCallback_type    osCallback</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span><span class="preprocessor">#define osCallback_ret     ret</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a>00102 <span class="preprocessor">#define SVC_0_1(f,t,...)                                                       \</span>
<a name="l00103"></a>00103 <span class="preprocessor">__svc_indirect(0) t  _##f (t(*)());                                            \</span>
<a name="l00104"></a>00104 <span class="preprocessor">                  t     f (void);                                              \</span>
<a name="l00105"></a>00105 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00106"></a>00106 <span class="preprocessor">static __inline   t __##f (void) {                                             \</span>
<a name="l00107"></a>00107 <span class="preprocessor">  return _##f(f);                                                              \</span>
<a name="l00108"></a>00108 <span class="preprocessor">}</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a>00110 <span class="preprocessor">#define SVC_1_1(f,t,t1,...)                                                    \</span>
<a name="l00111"></a>00111 <span class="preprocessor">__svc_indirect(0) t  _##f (t(*)(t1),t1);                                       \</span>
<a name="l00112"></a>00112 <span class="preprocessor">                  t     f (t1 a1);                                             \</span>
<a name="l00113"></a>00113 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00114"></a>00114 <span class="preprocessor">static __inline   t __##f (t1 a1) {                                            \</span>
<a name="l00115"></a>00115 <span class="preprocessor">  return _##f(f,a1);                                                           \</span>
<a name="l00116"></a>00116 <span class="preprocessor">}</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>
<a name="l00118"></a>00118 <span class="preprocessor">#define SVC_2_1(f,t,t1,t2,...)                                                 \</span>
<a name="l00119"></a>00119 <span class="preprocessor">__svc_indirect(0) t  _##f (t(*)(t1,t2),t1,t2);                                 \</span>
<a name="l00120"></a>00120 <span class="preprocessor">                  t     f (t1 a1, t2 a2);                                      \</span>
<a name="l00121"></a>00121 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00122"></a>00122 <span class="preprocessor">static __inline   t __##f (t1 a1, t2 a2) {                                     \</span>
<a name="l00123"></a>00123 <span class="preprocessor">  return _##f(f,a1,a2);                                                        \</span>
<a name="l00124"></a>00124 <span class="preprocessor">}</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>
<a name="l00126"></a>00126 <span class="preprocessor">#define SVC_3_1(f,t,t1,t2,t3,...)                                              \</span>
<a name="l00127"></a>00127 <span class="preprocessor">__svc_indirect(0) t  _##f (t(*)(t1,t2,t3),t1,t2,t3);                           \</span>
<a name="l00128"></a>00128 <span class="preprocessor">                  t     f (t1 a1, t2 a2, t3 a3);                               \</span>
<a name="l00129"></a>00129 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00130"></a>00130 <span class="preprocessor">static __inline   t __##f (t1 a1, t2 a2, t3 a3) {                              \</span>
<a name="l00131"></a>00131 <span class="preprocessor">  return _##f(f,a1,a2,a3);                                                     \</span>
<a name="l00132"></a>00132 <span class="preprocessor">}</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span>
<a name="l00134"></a>00134 <span class="preprocessor">#define SVC_4_1(f,t,t1,t2,t3,t4,...)                                           \</span>
<a name="l00135"></a>00135 <span class="preprocessor">__svc_indirect(0) t  _##f (t(*)(t1,t2,t3,t4),t1,t2,t3,t4);                     \</span>
<a name="l00136"></a>00136 <span class="preprocessor">                  t     f (t1 a1, t2 a2, t3 a3, t4 a4);                        \</span>
<a name="l00137"></a>00137 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00138"></a>00138 <span class="preprocessor">static __inline   t __##f (t1 a1, t2 a2, t3 a3, t4 a4) {                       \</span>
<a name="l00139"></a>00139 <span class="preprocessor">  return _##f(f,a1,a2,a3,a4);                                                  \</span>
<a name="l00140"></a>00140 <span class="preprocessor">}</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>
<a name="l00142"></a>00142 <span class="preprocessor">#define SVC_1_2 SVC_1_1 </span>
<a name="l00143"></a>00143 <span class="preprocessor"></span><span class="preprocessor">#define SVC_1_3 SVC_1_1 </span>
<a name="l00144"></a>00144 <span class="preprocessor"></span><span class="preprocessor">#define SVC_2_3 SVC_2_1 </span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146 <span class="preprocessor">#elif defined (__GNUC__)        </span><span class="comment">/* GNU Compiler */</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="preprocessor">#define __NO_RETURN __attribute__((noreturn))</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>
<a name="l00150"></a>00150 <span class="keyword">typedef</span> uint32_t __attribute__((vector_size(8)))  ret64;
<a name="l00151"></a>00151 typedef uint32_t __attribute__((vector_size(16))) ret128;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="preprocessor">#define RET_pointer    __r0</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span><span class="preprocessor">#define RET_int32_t    __r0</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span><span class="preprocessor">#define RET_osStatus   __r0</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span><span class="preprocessor">#define RET_osPriority __r0</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#define RET_osEvent    {(osStatus)__r0, {(uint32_t)__r1}, {(void *)__r2}}</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span><span class="preprocessor">#define RET_osCallback {(void *)__r0, (void *)__r1}</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>
<a name="l00160"></a>00160 <span class="preprocessor">#define osEvent_type        ret128</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_status (ret128){ret.status}</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_value  (ret128){ret.status, ret.value.v}</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_msg    (ret128){ret.status, ret.value.v, (uint32_t)ret.def.message_id}</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_mail   (ret128){ret.status, ret.value.v, (uint32_t)ret.def.mail_id}</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>
<a name="l00166"></a>00166 <span class="preprocessor">#define osCallback_type     ret64</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="preprocessor">#define osCallback_ret     (ret64) {(uint32_t)ret.fp, (uint32_t)ret.arg}</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>
<a name="l00169"></a>00169 <span class="preprocessor">#define SVC_ArgN(n) \</span>
<a name="l00170"></a>00170 <span class="preprocessor">  register int __r##n __asm(&quot;r&quot;#n);</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span>
<a name="l00172"></a>00172 <span class="preprocessor">#define SVC_ArgR(n,t,a) \</span>
<a name="l00173"></a>00173 <span class="preprocessor">  register t   __r##n __asm(&quot;r&quot;#n) = a;</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>
<a name="l00175"></a>00175 <span class="preprocessor">#define SVC_Arg0()                                                             \</span>
<a name="l00176"></a>00176 <span class="preprocessor">  SVC_ArgN(0)                                                                  \</span>
<a name="l00177"></a>00177 <span class="preprocessor">  SVC_ArgN(1)                                                                  \</span>
<a name="l00178"></a>00178 <span class="preprocessor">  SVC_ArgN(2)                                                                  \</span>
<a name="l00179"></a>00179 <span class="preprocessor">  SVC_ArgN(3)</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>
<a name="l00181"></a>00181 <span class="preprocessor">#define SVC_Arg1(t1)                                                           \</span>
<a name="l00182"></a>00182 <span class="preprocessor">  SVC_ArgR(0,t1,a1)                                                            \</span>
<a name="l00183"></a>00183 <span class="preprocessor">  SVC_ArgN(1)                                                                  \</span>
<a name="l00184"></a>00184 <span class="preprocessor">  SVC_ArgN(2)                                                                  \</span>
<a name="l00185"></a>00185 <span class="preprocessor">  SVC_ArgN(3)</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>
<a name="l00187"></a>00187 <span class="preprocessor">#define SVC_Arg2(t1,t2)                                                        \</span>
<a name="l00188"></a>00188 <span class="preprocessor">  SVC_ArgR(0,t1,a1)                                                            \</span>
<a name="l00189"></a>00189 <span class="preprocessor">  SVC_ArgR(1,t2,a2)                                                            \</span>
<a name="l00190"></a>00190 <span class="preprocessor">  SVC_ArgN(2)                                                                  \</span>
<a name="l00191"></a>00191 <span class="preprocessor">  SVC_ArgN(3)</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>
<a name="l00193"></a>00193 <span class="preprocessor">#define SVC_Arg3(t1,t2,t3)                                                     \</span>
<a name="l00194"></a>00194 <span class="preprocessor">  SVC_ArgR(0,t1,a1)                                                            \</span>
<a name="l00195"></a>00195 <span class="preprocessor">  SVC_ArgR(1,t2,a2)                                                            \</span>
<a name="l00196"></a>00196 <span class="preprocessor">  SVC_ArgR(2,t3,a3)                                                            \</span>
<a name="l00197"></a>00197 <span class="preprocessor">  SVC_ArgN(3)</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>
<a name="l00199"></a>00199 <span class="preprocessor">#define SVC_Arg4(t1,t2,t3,t4)                                                  \</span>
<a name="l00200"></a>00200 <span class="preprocessor">  SVC_ArgR(0,t1,a1)                                                            \</span>
<a name="l00201"></a>00201 <span class="preprocessor">  SVC_ArgR(1,t2,a2)                                                            \</span>
<a name="l00202"></a>00202 <span class="preprocessor">  SVC_ArgR(2,t3,a3)                                                            \</span>
<a name="l00203"></a>00203 <span class="preprocessor">  SVC_ArgR(3,t4,a4)</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span>
<a name="l00205"></a>00205 <span class="preprocessor">#if (defined (__CORTEX_M0)) || defined (__CORTEX_M0PLUS)</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span><span class="preprocessor">#define SVC_Call(f)                                                            \</span>
<a name="l00207"></a>00207 <span class="preprocessor">  __asm volatile                                                                 \</span>
<a name="l00208"></a>00208 <span class="preprocessor">  (                                                                            \</span>
<a name="l00209"></a>00209 <span class="preprocessor">    &quot;ldr r7,=&quot;#f&quot;\n\t&quot;                                                         \</span>
<a name="l00210"></a>00210 <span class="preprocessor">    &quot;mov r12,r7\n\t&quot;                                                           \</span>
<a name="l00211"></a>00211 <span class="preprocessor">    &quot;svc 0&quot;                                                                    \</span>
<a name="l00212"></a>00212 <span class="preprocessor">    :               &quot;=r&quot; (__r0), &quot;=r&quot; (__r1), &quot;=r&quot; (__r2), &quot;=r&quot; (__r3)         \</span>
<a name="l00213"></a>00213 <span class="preprocessor">    :                &quot;r&quot; (__r0),  &quot;r&quot; (__r1),  &quot;r&quot; (__r2),  &quot;r&quot; (__r3)         \</span>
<a name="l00214"></a>00214 <span class="preprocessor">    : &quot;r7&quot;, &quot;r12&quot;, &quot;lr&quot;, &quot;cc&quot;                                                  \</span>
<a name="l00215"></a>00215 <span class="preprocessor">  );</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span><span class="preprocessor">#define SVC_Call(f)                                                            \</span>
<a name="l00218"></a>00218 <span class="preprocessor">  __asm volatile                                                                 \</span>
<a name="l00219"></a>00219 <span class="preprocessor">  (                                                                            \</span>
<a name="l00220"></a>00220 <span class="preprocessor">    &quot;ldr r12,=&quot;#f&quot;\n\t&quot;                                                        \</span>
<a name="l00221"></a>00221 <span class="preprocessor">    &quot;svc 0&quot;                                                                    \</span>
<a name="l00222"></a>00222 <span class="preprocessor">    :               &quot;=r&quot; (__r0), &quot;=r&quot; (__r1), &quot;=r&quot; (__r2), &quot;=r&quot; (__r3)         \</span>
<a name="l00223"></a>00223 <span class="preprocessor">    :                &quot;r&quot; (__r0),  &quot;r&quot; (__r1),  &quot;r&quot; (__r2),  &quot;r&quot; (__r3)         \</span>
<a name="l00224"></a>00224 <span class="preprocessor">    : &quot;r12&quot;, &quot;lr&quot;, &quot;cc&quot;                                                        \</span>
<a name="l00225"></a>00225 <span class="preprocessor">  );</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>
<a name="l00228"></a>00228 <span class="preprocessor">#define SVC_0_1(f,t,rv)                                                        \</span>
<a name="l00229"></a>00229 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00230"></a>00230 <span class="preprocessor">static inline  t __##f (void) {                                                \</span>
<a name="l00231"></a>00231 <span class="preprocessor">  SVC_Arg0();                                                                  \</span>
<a name="l00232"></a>00232 <span class="preprocessor">  SVC_Call(f);                                                                 \</span>
<a name="l00233"></a>00233 <span class="preprocessor">  return (t) rv;                                                               \</span>
<a name="l00234"></a>00234 <span class="preprocessor">}</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>
<a name="l00236"></a>00236 <span class="preprocessor">#define SVC_1_1(f,t,t1,rv)                                                     \</span>
<a name="l00237"></a>00237 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00238"></a>00238 <span class="preprocessor">static inline  t __##f (t1 a1) {                                               \</span>
<a name="l00239"></a>00239 <span class="preprocessor">  SVC_Arg1(t1);                                                                \</span>
<a name="l00240"></a>00240 <span class="preprocessor">  SVC_Call(f);                                                                 \</span>
<a name="l00241"></a>00241 <span class="preprocessor">  return (t) rv;                                                               \</span>
<a name="l00242"></a>00242 <span class="preprocessor">}</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>
<a name="l00244"></a>00244 <span class="preprocessor">#define SVC_2_1(f,t,t1,t2,rv)                                                  \</span>
<a name="l00245"></a>00245 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00246"></a>00246 <span class="preprocessor">static inline  t __##f (t1 a1, t2 a2) {                                        \</span>
<a name="l00247"></a>00247 <span class="preprocessor">  SVC_Arg2(t1,t2);                                                             \</span>
<a name="l00248"></a>00248 <span class="preprocessor">  SVC_Call(f);                                                                 \</span>
<a name="l00249"></a>00249 <span class="preprocessor">  return (t) rv;                                                               \</span>
<a name="l00250"></a>00250 <span class="preprocessor">}</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>
<a name="l00252"></a>00252 <span class="preprocessor">#define SVC_3_1(f,t,t1,t2,t3,rv)                                               \</span>
<a name="l00253"></a>00253 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00254"></a>00254 <span class="preprocessor">static inline  t __##f (t1 a1, t2 a2, t3 a3) {                                 \</span>
<a name="l00255"></a>00255 <span class="preprocessor">  SVC_Arg3(t1,t2,t3);                                                          \</span>
<a name="l00256"></a>00256 <span class="preprocessor">  SVC_Call(f);                                                                 \</span>
<a name="l00257"></a>00257 <span class="preprocessor">  return (t) rv;                                                               \</span>
<a name="l00258"></a>00258 <span class="preprocessor">}</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>
<a name="l00260"></a>00260 <span class="preprocessor">#define SVC_4_1(f,t,t1,t2,t3,t4,rv)                                            \</span>
<a name="l00261"></a>00261 <span class="preprocessor">__attribute__((always_inline))                                                 \</span>
<a name="l00262"></a>00262 <span class="preprocessor">static inline  t __##f (t1 a1, t2 a2, t3 a3, t4 a4) {                          \</span>
<a name="l00263"></a>00263 <span class="preprocessor">  SVC_Arg4(t1,t2,t3,t4);                                                       \</span>
<a name="l00264"></a>00264 <span class="preprocessor">  SVC_Call(f);                                                                 \</span>
<a name="l00265"></a>00265 <span class="preprocessor">  return (t) rv;                                                               \</span>
<a name="l00266"></a>00266 <span class="preprocessor">}</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span>
<a name="l00268"></a>00268 <span class="preprocessor">#define SVC_1_2 SVC_1_1 </span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">#define SVC_1_3 SVC_1_1 </span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#define SVC_2_3 SVC_2_1 </span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>
<a name="l00272"></a>00272 <span class="preprocessor">#elif defined (__ICCARM__)      </span><span class="comment">/* IAR Compiler */</span>
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="preprocessor">#define __NO_RETURN __noreturn</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span>
<a name="l00276"></a>00276 <span class="preprocessor">#define RET_osEvent        &quot;=r&quot;(ret.status), &quot;=r&quot;(ret.value), &quot;=r&quot;(ret.def)</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span><span class="preprocessor">#define RET_osCallback     &quot;=r&quot;(ret.fp), &quot;=r&quot;(ret.arg)</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>
<a name="l00279"></a>00279 <span class="preprocessor">#define osEvent_type       osEvent</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_status ret</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_value  ret</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_msg    ret</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">#define osEvent_ret_mail   ret</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>
<a name="l00285"></a>00285 <span class="preprocessor">#define osCallback_type    uint64_t</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">#define osCallback_ret     ((uint64_t)ret.fp | ((uint64_t)ret.arg)&lt;&lt;32)</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>
<a name="l00288"></a>00288 <span class="preprocessor">#define SVC_Setup(f)                                                           \</span>
<a name="l00289"></a>00289 <span class="preprocessor">  __asm(                                                                         \</span>
<a name="l00290"></a>00290 <span class="preprocessor">    &quot;mov r12,%0\n&quot;                                                             \</span>
<a name="l00291"></a>00291 <span class="preprocessor">    :: &quot;r&quot;(&amp;f): &quot;r12&quot;                                                          \</span>
<a name="l00292"></a>00292 <span class="preprocessor">  );</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span>
<a name="l00294"></a>00294 <span class="preprocessor">#define SVC_Ret3()                                                             \</span>
<a name="l00295"></a>00295 <span class="preprocessor">  __asm(                                                                         \</span>
<a name="l00296"></a>00296 <span class="preprocessor">    &quot;ldr r0,[sp,#0]\n&quot;                                                         \</span>
<a name="l00297"></a>00297 <span class="preprocessor">    &quot;ldr r1,[sp,#4]\n&quot;                                                         \</span>
<a name="l00298"></a>00298 <span class="preprocessor">    &quot;ldr r2,[sp,#8]\n&quot;                                                         \</span>
<a name="l00299"></a>00299 <span class="preprocessor">  );</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span>
<a name="l00301"></a>00301 <span class="preprocessor">#define SVC_0_1(f,t,...)                                                       \</span>
<a name="l00302"></a>00302 <span class="preprocessor">t f (void);                                                                    \</span>
<a name="l00303"></a>00303 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi t _##f (void);                                   \</span>
<a name="l00304"></a>00304 <span class="preprocessor">static inline t __##f (void) {                                                 \</span>
<a name="l00305"></a>00305 <span class="preprocessor">  SVC_Setup(f);                                                                \</span>
<a name="l00306"></a>00306 <span class="preprocessor">  return _##f();                                                               \</span>
<a name="l00307"></a>00307 <span class="preprocessor">}</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>
<a name="l00309"></a>00309 <span class="preprocessor">#define SVC_1_1(f,t,t1,...)                                                    \</span>
<a name="l00310"></a>00310 <span class="preprocessor">t f (t1 a1);                                                                   \</span>
<a name="l00311"></a>00311 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi t _##f (t1 a1);                                  \</span>
<a name="l00312"></a>00312 <span class="preprocessor">static inline t __##f (t1 a1) {                                                \</span>
<a name="l00313"></a>00313 <span class="preprocessor">  SVC_Setup(f);                                                                \</span>
<a name="l00314"></a>00314 <span class="preprocessor">  return _##f(a1);                                                             \</span>
<a name="l00315"></a>00315 <span class="preprocessor">}</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>
<a name="l00317"></a>00317 <span class="preprocessor">#define SVC_2_1(f,t,t1,t2,...)                                                 \</span>
<a name="l00318"></a>00318 <span class="preprocessor">t f (t1 a1, t2 a2);                                                            \</span>
<a name="l00319"></a>00319 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi t _##f (t1 a1, t2 a2);                           \</span>
<a name="l00320"></a>00320 <span class="preprocessor">static inline t __##f (t1 a1, t2 a2) {                                         \</span>
<a name="l00321"></a>00321 <span class="preprocessor">  SVC_Setup(f);                                                                \</span>
<a name="l00322"></a>00322 <span class="preprocessor">  return _##f(a1,a2);                                                          \</span>
<a name="l00323"></a>00323 <span class="preprocessor">}</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>
<a name="l00325"></a>00325 <span class="preprocessor">#define SVC_3_1(f,t,t1,t2,t3,...)                                              \</span>
<a name="l00326"></a>00326 <span class="preprocessor">t f (t1 a1, t2 a2, t3 a3);                                                     \</span>
<a name="l00327"></a>00327 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi t _##f (t1 a1, t2 a2, t3 a3);                    \</span>
<a name="l00328"></a>00328 <span class="preprocessor">static inline t __##f (t1 a1, t2 a2, t3 a3) {                                  \</span>
<a name="l00329"></a>00329 <span class="preprocessor">  SVC_Setup(f);                                                                \</span>
<a name="l00330"></a>00330 <span class="preprocessor">  return _##f(a1,a2,a3);                                                       \</span>
<a name="l00331"></a>00331 <span class="preprocessor">}</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span>
<a name="l00333"></a>00333 <span class="preprocessor">#define SVC_4_1(f,t,t1,t2,t3,t4,...)                                           \</span>
<a name="l00334"></a>00334 <span class="preprocessor">t f (t1 a1, t2 a2, t3 a3, t4 a4);                                              \</span>
<a name="l00335"></a>00335 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi t _##f (t1 a1, t2 a2, t3 a3, t4 a4);             \</span>
<a name="l00336"></a>00336 <span class="preprocessor">static inline t __##f (t1 a1, t2 a2, t3 a3, t4 a4) {                           \</span>
<a name="l00337"></a>00337 <span class="preprocessor">  SVC_Setup(f);                                                                \</span>
<a name="l00338"></a>00338 <span class="preprocessor">  return _##f(a1,a2,a3,a4);                                                    \</span>
<a name="l00339"></a>00339 <span class="preprocessor">}</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>
<a name="l00341"></a>00341 <span class="preprocessor">#define SVC_1_2(f,t,t1,rr)                                                     \</span>
<a name="l00342"></a>00342 <span class="preprocessor">uint64_t f (t1 a1);                                                            \</span>
<a name="l00343"></a>00343 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi uint64_t _##f (t1 a1);                           \</span>
<a name="l00344"></a>00344 <span class="preprocessor">static inline t __##f (t1 a1) {                                                \</span>
<a name="l00345"></a>00345 <span class="preprocessor">  t ret;                                                                       \</span>
<a name="l00346"></a>00346 <span class="preprocessor">  SVC_Setup(f);                                                                \</span>
<a name="l00347"></a>00347 <span class="preprocessor">  _##f(a1);                                                                    \</span>
<a name="l00348"></a>00348 <span class="preprocessor">  __asm(&quot;&quot; : rr : :);                                                            \</span>
<a name="l00349"></a>00349 <span class="preprocessor">  return ret;                                                                  \</span>
<a name="l00350"></a>00350 <span class="preprocessor">}</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span>
<a name="l00352"></a>00352 <span class="preprocessor">#define SVC_1_3(f,t,t1,rr)                                                     \</span>
<a name="l00353"></a>00353 <span class="preprocessor">t f (t1 a1);                                                                   \</span>
<a name="l00354"></a>00354 <span class="preprocessor">void f##_ (t1 a1) {                                                            \</span>
<a name="l00355"></a>00355 <span class="preprocessor">  f(a1);                                                                       \</span>
<a name="l00356"></a>00356 <span class="preprocessor">  SVC_Ret3();                                                                  \</span>
<a name="l00357"></a>00357 <span class="preprocessor">}                                                                              \</span>
<a name="l00358"></a>00358 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi void _##f (t1 a1);                               \</span>
<a name="l00359"></a>00359 <span class="preprocessor">static inline t __##f (t1 a1) {                                                \</span>
<a name="l00360"></a>00360 <span class="preprocessor">  t ret;                                                                       \</span>
<a name="l00361"></a>00361 <span class="preprocessor">  SVC_Setup(f##_);                                                             \</span>
<a name="l00362"></a>00362 <span class="preprocessor">  _##f(a1);                                                                    \</span>
<a name="l00363"></a>00363 <span class="preprocessor">  __asm(&quot;&quot; : rr : :);                                                            \</span>
<a name="l00364"></a>00364 <span class="preprocessor">  return ret;                                                                  \</span>
<a name="l00365"></a>00365 <span class="preprocessor">}</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>
<a name="l00367"></a>00367 <span class="preprocessor">#define SVC_2_3(f,t,t1,t2,rr)                                                  \</span>
<a name="l00368"></a>00368 <span class="preprocessor">t f (t1 a1, t2 a2);                                                            \</span>
<a name="l00369"></a>00369 <span class="preprocessor">void f##_ (t1 a1, t2 a2) {                                                     \</span>
<a name="l00370"></a>00370 <span class="preprocessor">  f(a1,a2);                                                                    \</span>
<a name="l00371"></a>00371 <span class="preprocessor">  SVC_Ret3();                                                                  \</span>
<a name="l00372"></a>00372 <span class="preprocessor">}                                                                              \</span>
<a name="l00373"></a>00373 <span class="preprocessor">_Pragma(&quot;swi_number=0&quot;) __swi void _##f (t1 a1, t2 a2);                        \</span>
<a name="l00374"></a>00374 <span class="preprocessor">static inline t __##f (t1 a1, t2 a2) {                                         \</span>
<a name="l00375"></a>00375 <span class="preprocessor">  t ret;                                                                       \</span>
<a name="l00376"></a>00376 <span class="preprocessor">  SVC_Setup(f##_);                                                             \</span>
<a name="l00377"></a>00377 <span class="preprocessor">  _##f(a1,a2);                                                                 \</span>
<a name="l00378"></a>00378 <span class="preprocessor">  __asm(&quot;&quot; : rr : :);                                                            \</span>
<a name="l00379"></a>00379 <span class="preprocessor">  return ret;                                                                  \</span>
<a name="l00380"></a>00380 <span class="preprocessor">}</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>
<a name="l00382"></a>00382 <span class="preprocessor">#endif</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 <span class="comment">// Callback structure</span>
<a name="l00386"></a><a class="code" href="structosCallback.html">00386</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00387"></a><a class="code" href="structosCallback.html#af0638bc58679a5142b3b9f6a0e2f9195">00387</a>   <span class="keywordtype">void</span> *<a class="code" href="structosCallback.html#af0638bc58679a5142b3b9f6a0e2f9195">fp</a>;             <span class="comment">// Function pointer</span>
<a name="l00388"></a><a class="code" href="structosCallback.html#aed18a60ced37a709284f1130a46da51e">00388</a>   <span class="keywordtype">void</span> *<a class="code" href="structosCallback.html#aed18a60ced37a709284f1130a46da51e">arg</a>;            <span class="comment">// Function argument</span>
<a name="l00389"></a>00389 } <a class="code" href="structosCallback.html">osCallback</a>;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="comment">// OS Section definitions</span>
<a name="l00393"></a>00393 <span class="preprocessor">#ifdef OS_SECTIONS_LINK_INFO</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keyword">const</span> uint32_t  os_section_id$$Base;
<a name="l00395"></a>00395 <span class="keyword">extern</span> <span class="keyword">const</span> uint32_t  os_section_id$$Limit;
<a name="l00396"></a>00396 <span class="preprocessor">#endif</span>
<a name="l00397"></a>00397 <span class="preprocessor"></span>
<a name="l00398"></a>00398 <span class="comment">// OS Timers external resources</span>
<a name="l00399"></a>00399 <span class="keyword">extern</span> osThreadDef_t   <a class="code" href="rt__CMSIS_8c.html#a157b8e1dee24d24684300e9f361eb5ae">os_thread_def_osTimerThread</a>;
<a name="l00400"></a>00400 <span class="keyword">extern</span> osThreadId      <a class="code" href="rt__CMSIS_8c.html#a015efe8ee267055b39ecae8485a6fd14">osThreadId_osTimerThread</a>;
<a name="l00401"></a>00401 <span class="keyword">extern</span> osMessageQDef_t <a class="code" href="rt__CMSIS_8c.html#a1c620017ed8fb991d595f9e6b173a7d2">os_messageQ_def_osTimerMessageQ</a>;
<a name="l00402"></a>00402 <span class="keyword">extern</span> osMessageQId    <a class="code" href="rt__CMSIS_8c.html#a35cb91f2f5bc56ff50bdaee879ad51a2">osMessageQId_osTimerMessageQ</a>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="comment">// ==== Helper Functions ====</span>
<a name="l00406"></a>00406 
<a name="l00408"></a><a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b">00408</a> <span class="keyword">static</span> uint32_t <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a> (uint32_t millisec) {
<a name="l00409"></a>00409   uint32_t tick;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   <span class="keywordflow">if</span> (millisec == osWaitForever) <span class="keywordflow">return</span> 0xFFFF; <span class="comment">// Indefinite timeout</span>
<a name="l00412"></a>00412   <span class="keywordflow">if</span> (millisec &gt; 4000000) <span class="keywordflow">return</span> 0xFFFE;        <span class="comment">// Max ticks supported</span>
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   tick = ((1000 * millisec) + os_clockrate - 1)  / os_clockrate;
<a name="l00415"></a>00415   <span class="keywordflow">if</span> (tick &gt; 0xFFFE) <span class="keywordflow">return</span> 0xFFFE;
<a name="l00416"></a>00416   
<a name="l00417"></a>00417   <span class="keywordflow">return</span> tick;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00421"></a><a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c">00421</a> <span class="keyword">static</span> P_TCB <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a> (osThreadId thread_id) {
<a name="l00422"></a>00422   P_TCB ptcb;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   <span class="keywordflow">if</span> (thread_id == NULL) <span class="keywordflow">return</span> NULL;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   <span class="keywordflow">if</span> ((uint32_t)thread_id &amp; 3) <span class="keywordflow">return</span> NULL;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="preprocessor">#ifdef OS_SECTIONS_LINK_INFO</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((os_section_id$$Base != 0) &amp;&amp; (os_section_id$$Limit != 0)) {
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (thread_id  &lt; (osThreadId)os_section_id$$Base)  <span class="keywordflow">return</span> NULL;
<a name="l00431"></a>00431     <span class="keywordflow">if</span> (thread_id &gt;= (osThreadId)os_section_id$$Limit) <span class="keywordflow">return</span> NULL;
<a name="l00432"></a>00432   }
<a name="l00433"></a>00433 <span class="preprocessor">#endif</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span>
<a name="l00435"></a>00435   ptcb = thread_id;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437   <span class="keywordflow">if</span> (ptcb-&gt;cb_type != TCB) <span class="keywordflow">return</span> NULL;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439   <span class="keywordflow">return</span> ptcb;
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00443"></a><a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4">00443</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a> (<span class="keywordtype">void</span> *<span class="keywordtype">id</span>) {
<a name="l00444"></a>00444 
<a name="l00445"></a>00445   <span class="keywordflow">if</span> ((uint32_t)<span class="keywordtype">id</span> &amp; 3) <span class="keywordflow">return</span> NULL;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 <span class="preprocessor">#ifdef OS_SECTIONS_LINK_INFO</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((os_section_id$$Base != 0) &amp;&amp; (os_section_id$$Limit != 0)) {
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (<span class="keywordtype">id</span>  &lt; (<span class="keywordtype">void</span> *)os_section_id$$Base)  <span class="keywordflow">return</span> NULL;
<a name="l00450"></a>00450     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt;= (<span class="keywordtype">void</span> *)os_section_id$$Limit) <span class="keywordflow">return</span> NULL;
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452 <span class="preprocessor">#endif</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span>
<a name="l00454"></a>00454   <span class="keywordflow">return</span> id;
<a name="l00455"></a>00455 }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="comment">// ==== Kernel Control ====</span>
<a name="l00459"></a>00459 
<a name="l00460"></a><a class="code" href="rt__CMSIS_8c.html#a0bf5a32209bc083bd0708ddd4ac7c0ff">00460</a> uint8_t <a class="code" href="rt__CMSIS_8c.html#a0bf5a32209bc083bd0708ddd4ac7c0ff">os_initialized</a>;                         <span class="comment">// Kernel Initialized flag</span>
<a name="l00461"></a><a class="code" href="rt__CMSIS_8c.html#a1a5df38353443e089e482b52d2d97893">00461</a> uint8_t <a class="code" href="rt__CMSIS_8c.html#a1a5df38353443e089e482b52d2d97893">os_running</a>;                             <span class="comment">// Kernel Running flag</span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="comment">// Kernel Control Service Calls declarations</span>
<a name="l00464"></a>00464 SVC_0_1(<a class="code" href="rt__CMSIS_8c.html#a058799e729ffe29a7b7b644d12217989" title="Initialize the RTOS Kernel for creating objects.">svcKernelInitialize</a>, osStatus, RET_osStatus)
<a name="l00465"></a>00465 SVC_0_1(<a class="code" href="rt__CMSIS_8c.html#a8176fdc26796d73bc5e858b28e5f444a" title="Start the RTOS Kernel.">svcKernelStart</a>,      osStatus, RET_osStatus)
<a name="l00466"></a>00466 SVC_0_1(<a class="code" href="rt__CMSIS_8c.html#a383d4b037839cab290a24388bbbd871a" title="Check if the RTOS kernel is already started.">svcKernelRunning</a>,    int32_t,  RET_int32_t)
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 extern <span class="keywordtype">void</span>  <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>   (osStatus status);
<a name="l00469"></a>00469 osThreadId   <a class="code" href="rt__CMSIS_8c.html#a2bd72340bd6cb3639d5575a802b40cee" title="Create a thread and add it to Active Threads and set it to state READY.">svcThreadCreate</a>  (osThreadDef_t *thread_def, <span class="keywordtype">void</span> *argument);
<a name="l00470"></a>00470 osMessageQId <a class="code" href="rt__CMSIS_8c.html#a5b0709a1f60ee15cb01b11579d0b2981" title="Create and Initialize Message Queue.">svcMessageCreate</a> (osMessageQDef_t *queue_def, osThreadId thread_id);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 <span class="comment">// Kernel Control Service Calls</span>
<a name="l00473"></a>00473 
<a name="l00475"></a><a class="code" href="rt__CMSIS_8c.html#a058799e729ffe29a7b7b644d12217989">00475</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a058799e729ffe29a7b7b644d12217989" title="Initialize the RTOS Kernel for creating objects.">svcKernelInitialize</a> (<span class="keywordtype">void</span>) {
<a name="l00476"></a>00476   <span class="keywordflow">if</span> (os_initialized) <span class="keywordflow">return</span> osOK;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   rt_sys_init();                                <span class="comment">// RTX System Initialization</span>
<a name="l00479"></a>00479   os_tsk.run-&gt;prio = 255;                       <span class="comment">// Highest priority</span>
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osOK);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   os_initialized = 1;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   <span class="keywordflow">return</span> osOK;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00489"></a><a class="code" href="rt__CMSIS_8c.html#a8176fdc26796d73bc5e858b28e5f444a">00489</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a8176fdc26796d73bc5e858b28e5f444a" title="Start the RTOS Kernel.">svcKernelStart</a> (<span class="keywordtype">void</span>) {
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   <span class="keywordflow">if</span> (os_running) <span class="keywordflow">return</span> osOK;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="comment">// Create OS Timers resources (Message Queue &amp; Thread)</span>
<a name="l00494"></a>00494   osMessageQId_osTimerMessageQ = <a class="code" href="rt__CMSIS_8c.html#a5b0709a1f60ee15cb01b11579d0b2981" title="Create and Initialize Message Queue.">svcMessageCreate</a> (&amp;os_messageQ_def_osTimerMessageQ, NULL);
<a name="l00495"></a>00495   osThreadId_osTimerThread = <a class="code" href="rt__CMSIS_8c.html#a2bd72340bd6cb3639d5575a802b40cee" title="Create a thread and add it to Active Threads and set it to state READY.">svcThreadCreate</a>(&amp;os_thread_def_osTimerThread, NULL);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   rt_tsk_prio(0, 0);                            <span class="comment">// Lowest priority</span>
<a name="l00498"></a>00498   __set_PSP(os_tsk.run-&gt;tsk_stack + 8*4);       <span class="comment">// New context</span>
<a name="l00499"></a>00499   os_tsk.run = NULL;                            <span class="comment">// Force context switch</span>
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   rt_sys_start();
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   os_running = 1;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   <span class="keywordflow">return</span> osOK;
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 
<a name="l00509"></a><a class="code" href="rt__CMSIS_8c.html#a383d4b037839cab290a24388bbbd871a">00509</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a383d4b037839cab290a24388bbbd871a" title="Check if the RTOS kernel is already started.">svcKernelRunning</a>(<span class="keywordtype">void</span>) {
<a name="l00510"></a>00510   <span class="keywordflow">return</span> <a class="code" href="rt__CMSIS_8c.html#a1a5df38353443e089e482b52d2d97893">os_running</a>;
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 <span class="comment">// Kernel Control Public API</span>
<a name="l00514"></a>00514 
<a name="l00516"></a><a class="code" href="rt__CMSIS_8c.html#a53d078a801022e202e8115c083ece68e">00516</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> (<span class="keywordtype">void</span>) {
<a name="l00517"></a>00517   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l00518"></a>00518   <span class="keywordflow">if</span> ((__get_CONTROL() &amp; 1) == 0) {             <span class="comment">// Privileged mode</span>
<a name="l00519"></a>00519     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a058799e729ffe29a7b7b644d12217989" title="Initialize the RTOS Kernel for creating objects.">svcKernelInitialize</a>();
<a name="l00520"></a>00520   } <span class="keywordflow">else</span> {
<a name="l00521"></a>00521     <span class="keywordflow">return</span> __svcKernelInitialize();
<a name="l00522"></a>00522   }
<a name="l00523"></a>00523 }
<a name="l00524"></a>00524 
<a name="l00526"></a><a class="code" href="rt__CMSIS_8c.html#aab668ffd2ea76bb0a77ab0ab385eaef2">00526</a> osStatus <a class="code" href="rt__CMSIS_8c.html#aab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> (<span class="keywordtype">void</span>) {
<a name="l00527"></a>00527   uint32_t stack[8];
<a name="l00528"></a>00528   
<a name="l00529"></a>00529   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l00530"></a>00530   <span class="keywordflow">switch</span> (__get_CONTROL() &amp; 0x03) {
<a name="l00531"></a>00531     <span class="keywordflow">case</span> 0x00:                                  <span class="comment">// Privileged Thread mode &amp; MSP</span>
<a name="l00532"></a>00532       __set_PSP((uint32_t)(stack + 8));         <span class="comment">// Initial PSP</span>
<a name="l00533"></a>00533       <span class="keywordflow">if</span> (os_flags &amp; 1) {                       
<a name="l00534"></a>00534         __set_CONTROL(0x02);                    <span class="comment">// Set Privileged Thread mode &amp; PSP</span>
<a name="l00535"></a>00535       } <span class="keywordflow">else</span> {
<a name="l00536"></a>00536         __set_CONTROL(0x03);                    <span class="comment">// Set Unprivileged Thread mode &amp; PSP</span>
<a name="l00537"></a>00537       }
<a name="l00538"></a>00538       __DSB();
<a name="l00539"></a>00539       __ISB();
<a name="l00540"></a>00540       <span class="keywordflow">break</span>;
<a name="l00541"></a>00541     <span class="keywordflow">case</span> 0x01:                                  <span class="comment">// Unprivileged Thread mode &amp; MSP</span>
<a name="l00542"></a>00542       <span class="keywordflow">return</span> osErrorOS;
<a name="l00543"></a>00543     <span class="keywordflow">case</span> 0x02:                                  <span class="comment">// Privileged Thread mode &amp; PSP</span>
<a name="l00544"></a>00544       <span class="keywordflow">if</span> ((os_flags &amp; 1) == 0) {                <span class="comment">// Unprivileged Thread mode requested</span>
<a name="l00545"></a>00545         __set_CONTROL(0x03);                    <span class="comment">// Set Unprivileged Thread mode &amp; PSP</span>
<a name="l00546"></a>00546         __DSB();
<a name="l00547"></a>00547         __ISB();
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549       <span class="keywordflow">break</span>;
<a name="l00550"></a>00550     <span class="keywordflow">case</span> 0x03:                                  <span class="comment">// Unprivileged Thread mode &amp; PSP</span>
<a name="l00551"></a>00551       <span class="keywordflow">if</span>  (os_flags &amp; 1) <span class="keywordflow">return</span> osErrorOS;      <span class="comment">// Privileged Thread mode requested</span>
<a name="l00552"></a>00552       <span class="keywordflow">break</span>;
<a name="l00553"></a>00553   }
<a name="l00554"></a>00554   <span class="keywordflow">return</span> __svcKernelStart();
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00558"></a><a class="code" href="rt__CMSIS_8c.html#a3b571de44cd3094c643247a7397f86b5">00558</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a3b571de44cd3094c643247a7397f86b5" title="Check if the RTOS kernel is already started.">osKernelRunning</a>(<span class="keywordtype">void</span>) {
<a name="l00559"></a>00559   <span class="keywordflow">if</span> ((__get_IPSR() != 0) || ((__get_CONTROL() &amp; 1) == 0)) {
<a name="l00560"></a>00560     <span class="comment">// in ISR or Privileged</span>
<a name="l00561"></a>00561     <span class="keywordflow">return</span> <a class="code" href="rt__CMSIS_8c.html#a1a5df38353443e089e482b52d2d97893">os_running</a>;
<a name="l00562"></a>00562   } <span class="keywordflow">else</span> {
<a name="l00563"></a>00563     <span class="keywordflow">return</span> __svcKernelRunning();
<a name="l00564"></a>00564   }
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 <span class="comment">// ==== Thread Management ====</span>
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 __NO_RETURN <span class="keywordtype">void</span> <a class="code" href="rt__CMSIS_8c.html#addaa452dd7610e4096647a566d3556fc">osThreadExit</a> (<span class="keywordtype">void</span>);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 <span class="comment">// Thread Service Calls declarations</span>
<a name="l00573"></a>00573 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#a2bd72340bd6cb3639d5575a802b40cee" title="Create a thread and add it to Active Threads and set it to state READY.">svcThreadCreate</a>,      osThreadId, osThreadDef_t *, <span class="keywordtype">void</span> *,     RET_pointer)
<a name="l00574"></a>00574 SVC_0_1(<a class="code" href="rt__CMSIS_8c.html#a395cca131b7746fc43c104a3485b77f7" title="Return the thread ID of the current running thread.">svcThreadGetId</a>,       osThreadId,                              RET_pointer)
<a name="l00575"></a>00575 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a262ca4d6bccb52ac9a6819d008a21f11" title="Terminate execution of a thread and remove it from ActiveThreads.">svcThreadTerminate</a>,   osStatus,   osThreadId,                  RET_osStatus)
<a name="l00576"></a>00576 SVC_0_1(<a class="code" href="rt__CMSIS_8c.html#acee129ac168db3e83cdd6d7ceaab2109" title="Pass control to next thread that is in state READY.">svcThreadYield</a>,       osStatus,                                RET_osStatus)
<a name="l00577"></a>00577 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#afdd3791c5ec6023ba143315f2018fc51" title="Change priority of an active thread.">svcThreadSetPriority</a>, osStatus,   osThreadId,      osPriority, RET_osStatus)
<a name="l00578"></a>00578 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a5fe9a706b65cbe38c17854728aac8693" title="Get current priority of an active thread.">svcThreadGetPriority</a>, osPriority, osThreadId,                  RET_osPriority)
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="comment">// Thread Service Calls</span>
<a name="l00581"></a>00581 extern OS_TID <a class="code" href="rt__CMSIS_8c.html#a333fa199ceb516d7807ddf4e1232ff4c">rt_get_TID</a> (<span class="keywordtype">void</span>);
<a name="l00582"></a>00582 extern <span class="keywordtype">void</span>   <a class="code" href="rt__CMSIS_8c.html#a5995653d723ded69aa8ea566b3202ac3">rt_init_context</a> (P_TCB p_TCB, U8 priority, FUNCP task_body);
<a name="l00583"></a>00583 
<a name="l00585"></a><a class="code" href="rt__CMSIS_8c.html#a2bd72340bd6cb3639d5575a802b40cee">00585</a> osThreadId <a class="code" href="rt__CMSIS_8c.html#a2bd72340bd6cb3639d5575a802b40cee" title="Create a thread and add it to Active Threads and set it to state READY.">svcThreadCreate</a> (osThreadDef_t *thread_def, <span class="keywordtype">void</span> *argument) {
<a name="l00586"></a>00586   P_TCB  ptcb;
<a name="l00587"></a>00587   
<a name="l00588"></a>00588   <span class="keywordflow">if</span> ((thread_def == NULL) ||
<a name="l00589"></a>00589       (thread_def-&gt;pthread == NULL) ||
<a name="l00590"></a>00590       (thread_def-&gt;tpriority &lt; osPriorityIdle) ||
<a name="l00591"></a>00591       (thread_def-&gt;tpriority &gt; osPriorityRealtime) ||
<a name="l00592"></a>00592       (thread_def-&gt;stacksize == 0) ||
<a name="l00593"></a>00593       (thread_def-&gt;stack_pointer == NULL) ) {
<a name="l00594"></a>00594     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter); 
<a name="l00595"></a>00595     <span class="keywordflow">return</span> NULL; 
<a name="l00596"></a>00596   }
<a name="l00597"></a>00597   
<a name="l00598"></a>00598   U8 priority = thread_def-&gt;tpriority - osPriorityIdle + 1;
<a name="l00599"></a>00599   P_TCB task_context = &amp;thread_def-&gt;tcb;
<a name="l00600"></a>00600   
<a name="l00601"></a>00601   <span class="comment">/* If &quot;size != 0&quot; use a private user provided stack. */</span>
<a name="l00602"></a>00602   task_context-&gt;stack      = (U32*)thread_def-&gt;stack_pointer;
<a name="l00603"></a>00603   task_context-&gt;priv_stack = thread_def-&gt;stacksize;
<a name="l00604"></a>00604   <span class="comment">/* Pass parameter &#39;argv&#39; to &#39;rt_init_context&#39; */</span>
<a name="l00605"></a>00605   task_context-&gt;msg = argument;
<a name="l00606"></a>00606   OS_TID tsk = <a class="code" href="rt__CMSIS_8c.html#a333fa199ceb516d7807ddf4e1232ff4c">rt_get_TID</a> ();   <span class="comment">//CHANGED MBED LIBRARY HERE</span>
<a name="l00607"></a>00607   task_context-&gt;task_id = tsk;  <span class="comment">//CHANGED MBED LIBRARY HERE</span>
<a name="l00608"></a>00608   <span class="comment">/* For &#39;size == 0&#39; system allocates the user stack from the memory pool. */</span>
<a name="l00609"></a>00609   <a class="code" href="rt__CMSIS_8c.html#a5995653d723ded69aa8ea566b3202ac3">rt_init_context</a> (task_context, priority, (FUNCP)thread_def-&gt;pthread);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   <span class="comment">/* Find a free entry in &#39;os_active_TCB&#39; table. */</span>
<a name="l00612"></a>00612 <span class="comment">//  OS_TID tsk = rt_get_TID (); //CHANGED MBED LIBRARY HERE</span>
<a name="l00613"></a>00613   os_active_TCB[tsk-1] = task_context;
<a name="l00614"></a>00614 <span class="comment">//  task_context-&gt;task_id = tsk;        //CHANGED MBED LIBRARY HERE</span>
<a name="l00615"></a>00615   DBG_TASK_NOTIFY(task_context, __TRUE);
<a name="l00616"></a>00616   rt_dispatch (task_context);
<a name="l00617"></a>00617   
<a name="l00618"></a>00618   ptcb = (P_TCB)os_active_TCB[tsk - 1];         <span class="comment">// TCB pointer</span>
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   *((uint32_t *)ptcb-&gt;tsk_stack + 13) = (uint32_t)<a class="code" href="rt__CMSIS_8c.html#addaa452dd7610e4096647a566d3556fc">osThreadExit</a>;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <span class="keywordflow">return</span> ptcb;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00626"></a><a class="code" href="rt__CMSIS_8c.html#a395cca131b7746fc43c104a3485b77f7">00626</a> osThreadId <a class="code" href="rt__CMSIS_8c.html#a395cca131b7746fc43c104a3485b77f7" title="Return the thread ID of the current running thread.">svcThreadGetId</a> (<span class="keywordtype">void</span>) {
<a name="l00627"></a>00627   OS_TID tsk;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629   tsk = rt_tsk_self();
<a name="l00630"></a>00630   <span class="keywordflow">if</span> (tsk == 0) <span class="keywordflow">return</span> NULL;
<a name="l00631"></a>00631   <span class="keywordflow">return</span> (P_TCB)os_active_TCB[tsk - 1];
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00635"></a><a class="code" href="rt__CMSIS_8c.html#a262ca4d6bccb52ac9a6819d008a21f11">00635</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a262ca4d6bccb52ac9a6819d008a21f11" title="Terminate execution of a thread and remove it from ActiveThreads.">svcThreadTerminate</a> (osThreadId thread_id) {
<a name="l00636"></a>00636   OS_RESULT res;
<a name="l00637"></a>00637   P_TCB     ptcb;
<a name="l00638"></a>00638   
<a name="l00639"></a>00639   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l00640"></a>00640   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l00641"></a>00641   
<a name="l00642"></a>00642   res = rt_tsk_delete(ptcb-&gt;task_id);           <span class="comment">// Delete task</span>
<a name="l00643"></a>00643 
<a name="l00644"></a>00644   <span class="keywordflow">if</span> (res == OS_R_NOK) <span class="keywordflow">return</span> osErrorResource;  <span class="comment">// Delete task failed</span>
<a name="l00645"></a>00645   
<a name="l00646"></a>00646   <span class="keywordflow">return</span> osOK;
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00650"></a><a class="code" href="rt__CMSIS_8c.html#acee129ac168db3e83cdd6d7ceaab2109">00650</a> osStatus <a class="code" href="rt__CMSIS_8c.html#acee129ac168db3e83cdd6d7ceaab2109" title="Pass control to next thread that is in state READY.">svcThreadYield</a> (<span class="keywordtype">void</span>) {
<a name="l00651"></a>00651   rt_tsk_pass();                                <span class="comment">// Pass control to next task</span>
<a name="l00652"></a>00652   <span class="keywordflow">return</span> osOK;
<a name="l00653"></a>00653 }
<a name="l00654"></a>00654 
<a name="l00656"></a><a class="code" href="rt__CMSIS_8c.html#afdd3791c5ec6023ba143315f2018fc51">00656</a> osStatus <a class="code" href="rt__CMSIS_8c.html#afdd3791c5ec6023ba143315f2018fc51" title="Change priority of an active thread.">svcThreadSetPriority</a> (osThreadId thread_id, osPriority priority) {
<a name="l00657"></a>00657   OS_RESULT res;
<a name="l00658"></a>00658   P_TCB     ptcb;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l00661"></a>00661   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <span class="keywordflow">if</span> ((priority &lt; osPriorityIdle) || (priority &gt; osPriorityRealtime)) {
<a name="l00664"></a>00664     <span class="keywordflow">return</span> osErrorValue;
<a name="l00665"></a>00665   }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667   res = rt_tsk_prio(                            <span class="comment">// Change task priority</span>
<a name="l00668"></a>00668     ptcb-&gt;task_id,                              <span class="comment">// Task ID</span>
<a name="l00669"></a>00669     priority - osPriorityIdle + 1               <span class="comment">// New task priority</span>
<a name="l00670"></a>00670   );
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="keywordflow">if</span> (res == OS_R_NOK) <span class="keywordflow">return</span> osErrorResource;  <span class="comment">// Change task priority failed</span>
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="keywordflow">return</span> osOK;
<a name="l00675"></a>00675 }
<a name="l00676"></a>00676 
<a name="l00678"></a><a class="code" href="rt__CMSIS_8c.html#a5fe9a706b65cbe38c17854728aac8693">00678</a> osPriority <a class="code" href="rt__CMSIS_8c.html#a5fe9a706b65cbe38c17854728aac8693" title="Get current priority of an active thread.">svcThreadGetPriority</a> (osThreadId thread_id) {
<a name="l00679"></a>00679   P_TCB ptcb;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l00682"></a>00682   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> osPriorityError;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684   <span class="keywordflow">return</span> (osPriority)(ptcb-&gt;prio - 1 + osPriorityIdle); 
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 <span class="comment">// Thread Public API</span>
<a name="l00689"></a>00689 
<a name="l00691"></a><a class="code" href="rt__CMSIS_8c.html#a9e8ce62ab5f8c169d025af8c52e715db">00691</a> osThreadId <a class="code" href="rt__CMSIS_8c.html#a9e8ce62ab5f8c169d025af8c52e715db" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (osThreadDef_t *thread_def, <span class="keywordtype">void</span> *argument) {
<a name="l00692"></a>00692   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l00693"></a>00693   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l00694"></a>00694     <span class="comment">// Privileged and not running</span>
<a name="l00695"></a>00695     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a2bd72340bd6cb3639d5575a802b40cee" title="Create a thread and add it to Active Threads and set it to state READY.">svcThreadCreate</a>(thread_def, argument);
<a name="l00696"></a>00696   } <span class="keywordflow">else</span> {
<a name="l00697"></a>00697     <span class="keywordflow">return</span> __svcThreadCreate(thread_def, argument);
<a name="l00698"></a>00698   }
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00702"></a><a class="code" href="rt__CMSIS_8c.html#ab1df2a28925862ef8f9cf4e1c995c5a7">00702</a> osThreadId <a class="code" href="rt__CMSIS_8c.html#ab1df2a28925862ef8f9cf4e1c995c5a7" title="Return the thread ID of the current running thread.">osThreadGetId</a> (<span class="keywordtype">void</span>) {
<a name="l00703"></a>00703   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l00704"></a>00704   <span class="keywordflow">return</span> __svcThreadGetId();
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00708"></a><a class="code" href="rt__CMSIS_8c.html#aea135bb90eb853eff39e0800b91bbeab">00708</a> osStatus <a class="code" href="rt__CMSIS_8c.html#aea135bb90eb853eff39e0800b91bbeab" title="Terminate execution of a thread and remove it from ActiveThreads.">osThreadTerminate</a> (osThreadId thread_id) {
<a name="l00709"></a>00709   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l00710"></a>00710   <span class="keywordflow">return</span> __svcThreadTerminate(thread_id);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00714"></a><a class="code" href="rt__CMSIS_8c.html#af13a667493c5d629a90c13e113b99233">00714</a> osStatus <a class="code" href="rt__CMSIS_8c.html#af13a667493c5d629a90c13e113b99233" title="Pass control to next thread that is in state READY.">osThreadYield</a> (<span class="keywordtype">void</span>) {
<a name="l00715"></a>00715   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l00716"></a>00716   <span class="keywordflow">return</span> __svcThreadYield();
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00720"></a><a class="code" href="rt__CMSIS_8c.html#a0dfb90ccf1f6e4b54b9251b12d1cbc8b">00720</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a0dfb90ccf1f6e4b54b9251b12d1cbc8b" title="Change priority of an active thread.">osThreadSetPriority</a> (osThreadId thread_id, osPriority priority) {
<a name="l00721"></a>00721   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l00722"></a>00722   <span class="keywordflow">return</span> __svcThreadSetPriority(thread_id, priority);
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00726"></a><a class="code" href="rt__CMSIS_8c.html#a4299d838978bc2aae5e4350754e6a4e9">00726</a> osPriority <a class="code" href="rt__CMSIS_8c.html#a4299d838978bc2aae5e4350754e6a4e9" title="Get current priority of an active thread.">osThreadGetPriority</a> (osThreadId thread_id) {
<a name="l00727"></a>00727   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osPriorityError;<span class="comment">// Not allowed in ISR</span>
<a name="l00728"></a>00728   <span class="keywordflow">return</span> __svcThreadGetPriority(thread_id);
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00733"></a><a class="code" href="rt__CMSIS_8c.html#addaa452dd7610e4096647a566d3556fc">00733</a> __NO_RETURN <span class="keywordtype">void</span> <a class="code" href="rt__CMSIS_8c.html#addaa452dd7610e4096647a566d3556fc">osThreadExit</a> (<span class="keywordtype">void</span>) { 
<a name="l00734"></a>00734   __svcThreadTerminate(__svcThreadGetId()); 
<a name="l00735"></a>00735   <span class="keywordflow">for</span> (;;);                                     <span class="comment">// Should never come here</span>
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="comment">// ==== Generic Wait Functions ====</span>
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="comment">// Generic Wait Service Calls declarations</span>
<a name="l00742"></a>00742 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a5921000e995efbd236ed690f45370512" title="Wait for Timeout (Time Delay)">svcDelay</a>,           osStatus, uint32_t, RET_osStatus)
<a name="l00743"></a>00743 <span class="preprocessor">#if osFeature_Wait != 0</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span>SVC_1_3(svcWait,  os_InRegs osEvent,  uint32_t, RET_osEvent)
<a name="l00745"></a>00745 <span class="preprocessor">#endif</span>
<a name="l00746"></a>00746 <span class="preprocessor"></span>
<a name="l00747"></a>00747 <span class="comment">// Generic Wait Service Calls</span>
<a name="l00748"></a>00748 
<a name="l00750"></a><a class="code" href="rt__CMSIS_8c.html#a5921000e995efbd236ed690f45370512">00750</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a5921000e995efbd236ed690f45370512" title="Wait for Timeout (Time Delay)">svcDelay</a> (uint32_t millisec) {
<a name="l00751"></a>00751   <span class="keywordflow">if</span> (millisec == 0) <span class="keywordflow">return</span> osOK;
<a name="l00752"></a>00752   rt_dly_wait(<a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec));
<a name="l00753"></a>00753   <span class="keywordflow">return</span> osEventTimeout;
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00757"></a>00757 <span class="preprocessor">#if osFeature_Wait != 0</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>os_InRegs osEvent_type svcWait (uint32_t millisec) {
<a name="l00759"></a>00759   osEvent ret;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="keywordflow">if</span> (millisec == 0) {
<a name="l00762"></a>00762     ret.status = osOK;
<a name="l00763"></a>00763     <span class="keywordflow">return</span> osEvent_ret_status;
<a name="l00764"></a>00764   }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766   <span class="comment">/* To Do: osEventSignal, osEventMessage, osEventMail */</span>
<a name="l00767"></a>00767   rt_dly_wait(<a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec));
<a name="l00768"></a>00768   ret.status = osEventTimeout;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770   <span class="keywordflow">return</span> osEvent_ret_status;
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 <span class="preprocessor">#endif</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="comment">// Generic Wait API</span>
<a name="l00776"></a>00776 
<a name="l00778"></a><a class="code" href="rt__CMSIS_8c.html#a02e19d5e723bfb06ba9324d625162255">00778</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a02e19d5e723bfb06ba9324d625162255" title="Wait for Signal, Message, Mail, or Timeout.">osDelay</a> (uint32_t millisec) {
<a name="l00779"></a>00779   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l00780"></a>00780   <span class="keywordflow">return</span> __svcDelay(millisec);
<a name="l00781"></a>00781 }
<a name="l00782"></a>00782 
<a name="l00784"></a><a class="code" href="rt__CMSIS_8c.html#a2d265b787369ca5f0c59bef888d426e7">00784</a> os_InRegs osEvent <a class="code" href="rt__CMSIS_8c.html#a2d265b787369ca5f0c59bef888d426e7" title="Wait for Signal, Message, Mail, or Timeout.">osWait</a> (uint32_t millisec) {
<a name="l00785"></a>00785   osEvent ret;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="preprocessor">#if osFeature_Wait == 0</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span>  ret.status = osErrorOS;
<a name="l00789"></a>00789   <span class="keywordflow">return</span> ret;
<a name="l00790"></a>00790 <span class="preprocessor">#else</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// Not allowed in ISR</span>
<a name="l00792"></a>00792     ret.status = osErrorISR;
<a name="l00793"></a>00793     <span class="keywordflow">return</span> ret;
<a name="l00794"></a>00794   }
<a name="l00795"></a>00795   <span class="keywordflow">return</span> __svcWait(millisec);
<a name="l00796"></a>00796 <span class="preprocessor">#endif</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>}
<a name="l00798"></a>00798 
<a name="l00799"></a>00799 
<a name="l00800"></a>00800 <span class="comment">// ==== Timer Management ====</span>
<a name="l00801"></a>00801 
<a name="l00802"></a>00802 <span class="comment">// Timer definitions</span>
<a name="l00803"></a><a class="code" href="rt__CMSIS_8c.html#a5f9ab05e8080a71759e439aad84ae5a9">00803</a> <span class="preprocessor">#define osTimerInvalid  0</span>
<a name="l00804"></a><a class="code" href="rt__CMSIS_8c.html#a269ef354d9e85e536de2a58f44459399">00804</a> <span class="preprocessor"></span><span class="preprocessor">#define osTimerStopped  1</span>
<a name="l00805"></a><a class="code" href="rt__CMSIS_8c.html#aa575e7b23afe0438ea73dbb72345da59">00805</a> <span class="preprocessor"></span><span class="preprocessor">#define osTimerRunning  2</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span>
<a name="l00807"></a>00807 <span class="comment">// Timer structures </span>
<a name="l00808"></a>00808 
<a name="l00809"></a><a class="code" href="structos__timer__cb__.html">00809</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structos__timer__cb__.html">os_timer_cb_</a> {                   <span class="comment">// Timer Control Block</span>
<a name="l00810"></a><a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">00810</a>   <span class="keyword">struct </span><a class="code" href="structos__timer__cb__.html">os_timer_cb_</a> *<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>;                    <span class="comment">// Pointer to next active Timer</span>
<a name="l00811"></a><a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">00811</a>   uint8_t             <a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a>;                    <span class="comment">// Timer State</span>
<a name="l00812"></a><a class="code" href="structos__timer__cb__.html#a67fd97273c95f7f577c81c40a50d7752">00812</a>   uint8_t              <a class="code" href="structos__timer__cb__.html#a67fd97273c95f7f577c81c40a50d7752">type</a>;                    <span class="comment">// Timer Type (Periodic/One-shot)</span>
<a name="l00813"></a><a class="code" href="structos__timer__cb__.html#a94cbbdd66f94f41af67626ed87633dda">00813</a>   uint16_t         <a class="code" href="structos__timer__cb__.html#a94cbbdd66f94f41af67626ed87633dda">reserved</a>;                    <span class="comment">// Reserved</span>
<a name="l00814"></a><a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">00814</a>   uint16_t             <a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>;                    <span class="comment">// Timer Delay Count</span>
<a name="l00815"></a><a class="code" href="structos__timer__cb__.html#ac3902cb8f1f52b6e73206ec5b97e4e48">00815</a>   uint16_t             <a class="code" href="structos__timer__cb__.html#ac3902cb8f1f52b6e73206ec5b97e4e48">icnt</a>;                    <span class="comment">// Timer Initial Count </span>
<a name="l00816"></a><a class="code" href="structos__timer__cb__.html#a5407388cba31bfcf592af5479fc0e91b">00816</a>   <span class="keywordtype">void</span>                 *<a class="code" href="structos__timer__cb__.html#a5407388cba31bfcf592af5479fc0e91b">arg</a>;                    <span class="comment">// Timer Function Argument</span>
<a name="l00817"></a><a class="code" href="structos__timer__cb__.html#a30fa9f00974beea0d6ba5cb88c8cb1f4">00817</a>   osTimerDef_t       *<a class="code" href="structos__timer__cb__.html#a30fa9f00974beea0d6ba5cb88c8cb1f4">timer</a>;                    <span class="comment">// Pointer to Timer definition</span>
<a name="l00818"></a>00818 } <a class="code" href="rt__CMSIS_8c.html#a01ee3b224fa25cb7326c7ff965a363d9">os_timer_cb</a>;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 <span class="comment">// Timer variables</span>
<a name="l00821"></a><a class="code" href="rt__CMSIS_8c.html#a4de6937be649800bd3a62c2b6fb5589e">00821</a> <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *<a class="code" href="rt__CMSIS_8c.html#a4de6937be649800bd3a62c2b6fb5589e">os_timer_head</a>;                     <span class="comment">// Pointer to first active Timer</span>
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="comment">// Timer Helper Functions</span>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 <span class="comment">// Insert Timer into the list sorted by time</span>
<a name="l00827"></a><a class="code" href="rt__CMSIS_8c.html#a21de0bf1d7f000640f4d49a4f4338fb9">00827</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rt__CMSIS_8c.html#a21de0bf1d7f000640f4d49a4f4338fb9">rt_timer_insert</a> (<a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt, uint32_t <a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>) {
<a name="l00828"></a>00828   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *p, *prev;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   prev = NULL;
<a name="l00831"></a>00831   p = <a class="code" href="rt__CMSIS_8c.html#a4de6937be649800bd3a62c2b6fb5589e">os_timer_head</a>;
<a name="l00832"></a>00832   <span class="keywordflow">while</span> (p != NULL) {
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (tcnt &lt; p-&gt;tcnt) <span class="keywordflow">break</span>;
<a name="l00834"></a>00834     tcnt -= p-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>;
<a name="l00835"></a>00835     prev = p;
<a name="l00836"></a>00836     p = p-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>;
<a name="l00837"></a>00837   }
<a name="l00838"></a>00838   pt-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a> = p;
<a name="l00839"></a>00839   pt-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a> = (uint16_t)tcnt;
<a name="l00840"></a>00840   <span class="keywordflow">if</span> (p != NULL) {
<a name="l00841"></a>00841     p-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a> -= pt-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>;
<a name="l00842"></a>00842   }
<a name="l00843"></a>00843   <span class="keywordflow">if</span> (prev != NULL) {
<a name="l00844"></a>00844     prev-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a> = pt;
<a name="l00845"></a>00845   } <span class="keywordflow">else</span> {
<a name="l00846"></a>00846     os_timer_head = pt;
<a name="l00847"></a>00847   }
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850 <span class="comment">// Remove Timer from the list</span>
<a name="l00851"></a><a class="code" href="rt__CMSIS_8c.html#a4065ec6b7ff80270913acd949736d506">00851</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rt__CMSIS_8c.html#a4065ec6b7ff80270913acd949736d506">rt_timer_remove</a> (<a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt) {
<a name="l00852"></a>00852   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *p, *prev;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854   prev = NULL;
<a name="l00855"></a>00855   p = <a class="code" href="rt__CMSIS_8c.html#a4de6937be649800bd3a62c2b6fb5589e">os_timer_head</a>;
<a name="l00856"></a>00856   <span class="keywordflow">while</span> (p != NULL) {
<a name="l00857"></a>00857     <span class="keywordflow">if</span> (p == pt) <span class="keywordflow">break</span>;
<a name="l00858"></a>00858     prev = p;
<a name="l00859"></a>00859     p = p-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>;
<a name="l00860"></a>00860   }
<a name="l00861"></a>00861   <span class="keywordflow">if</span> (p == NULL) <span class="keywordflow">return</span> -1;
<a name="l00862"></a>00862   <span class="keywordflow">if</span> (prev != NULL) {
<a name="l00863"></a>00863     prev-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a> = pt-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>;
<a name="l00864"></a>00864   } <span class="keywordflow">else</span> {
<a name="l00865"></a>00865     os_timer_head = pt-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>;
<a name="l00866"></a>00866   }
<a name="l00867"></a>00867   <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a> != NULL) {
<a name="l00868"></a>00868     pt-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a> += pt-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>;
<a name="l00869"></a>00869   }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871   <span class="keywordflow">return</span> 0;
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 
<a name="l00875"></a>00875 <span class="comment">// Timer Service Calls declarations</span>
<a name="l00876"></a>00876 SVC_3_1(<a class="code" href="rt__CMSIS_8c.html#a04035bf8187a3f63df32bb9c38cda4ef" title="Create timer.">svcTimerCreate</a>,           osTimerId,  osTimerDef_t *, os_timer_type, <span class="keywordtype">void</span> *, RET_pointer)
<a name="l00877"></a>00877 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#a602f285d8274d4e8ab6e897d464be054" title="Start or restart timer.">svcTimerStart</a>,            osStatus,   osTimerId,      uint32_t,              RET_osStatus)
<a name="l00878"></a>00878 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a88bf6dbc5f80cb5d736548cd3e7cef97" title="Stop timer.">svcTimerStop</a>,             osStatus,   osTimerId,                             RET_osStatus)
<a name="l00879"></a>00879 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a4d052f205759d3face595af827f17463" title="Delete timer.">svcTimerDelete</a>,           osStatus,   osTimerId,                             RET_osStatus)
<a name="l00880"></a>00880 SVC_1_2(<a class="code" href="rt__CMSIS_8c.html#af951f809d922f5d81b788d6d2e67aa27" title="Get timer callback parameters.">svcTimerCall</a>,   os_InRegs <a class="code" href="structosCallback.html">osCallback</a>, osTimerId,                             RET_osCallback)
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="comment">// Timer Management Service Calls</span>
<a name="l00883"></a>00883 
<a name="l00885"></a><a class="code" href="rt__CMSIS_8c.html#a04035bf8187a3f63df32bb9c38cda4ef">00885</a> osTimerId <a class="code" href="rt__CMSIS_8c.html#a04035bf8187a3f63df32bb9c38cda4ef" title="Create timer.">svcTimerCreate</a> (osTimerDef_t *timer_def, os_timer_type <a class="code" href="structos__timer__cb__.html#a67fd97273c95f7f577c81c40a50d7752">type</a>, <span class="keywordtype">void</span> *argument) {
<a name="l00886"></a>00886   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888   <span class="keywordflow">if</span> ((timer_def == NULL) || (timer_def-&gt;ptimer == NULL)) {
<a name="l00889"></a>00889     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l00890"></a>00890     <span class="keywordflow">return</span> NULL;
<a name="l00891"></a>00891   }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893   pt = timer_def-&gt;<a class="code" href="structos__timer__cb__.html#a30fa9f00974beea0d6ba5cb88c8cb1f4">timer</a>;
<a name="l00894"></a>00894   <span class="keywordflow">if</span> (pt == NULL) {
<a name="l00895"></a>00895     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l00896"></a>00896     <span class="keywordflow">return</span> NULL;
<a name="l00897"></a>00897   }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899   <span class="keywordflow">if</span> ((type != osTimerOnce) &amp;&amp; (type != osTimerPeriodic)) {
<a name="l00900"></a>00900     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorValue);
<a name="l00901"></a>00901     <span class="keywordflow">return</span> NULL;
<a name="l00902"></a>00902   }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904   <span class="keywordflow">if</span> (osThreadId_osTimerThread == NULL) {
<a name="l00905"></a>00905     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorResource);
<a name="l00906"></a>00906     <span class="keywordflow">return</span> NULL;
<a name="l00907"></a>00907   }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909   <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a> != <a class="code" href="rt__CMSIS_8c.html#a5f9ab05e8080a71759e439aad84ae5a9">osTimerInvalid</a>){
<a name="l00910"></a>00910     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorResource);
<a name="l00911"></a>00911     <span class="keywordflow">return</span> NULL;
<a name="l00912"></a>00912   }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914   pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a> = <a class="code" href="rt__CMSIS_8c.html#a269ef354d9e85e536de2a58f44459399">osTimerStopped</a>;
<a name="l00915"></a>00915   pt-&gt;<a class="code" href="structos__timer__cb__.html#a67fd97273c95f7f577c81c40a50d7752">type</a>  =  (uint8_t)type;
<a name="l00916"></a>00916   pt-&gt;<a class="code" href="structos__timer__cb__.html#a5407388cba31bfcf592af5479fc0e91b">arg</a>   = argument;
<a name="l00917"></a>00917   pt-&gt;<a class="code" href="structos__timer__cb__.html#a30fa9f00974beea0d6ba5cb88c8cb1f4">timer</a> = timer_def;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919   <span class="keywordflow">return</span> (osTimerId)pt;
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00923"></a><a class="code" href="rt__CMSIS_8c.html#a602f285d8274d4e8ab6e897d464be054">00923</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a602f285d8274d4e8ab6e897d464be054" title="Start or restart timer.">svcTimerStart</a> (osTimerId timer_id, uint32_t millisec) {
<a name="l00924"></a>00924   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt;
<a name="l00925"></a>00925   uint32_t     <a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927   pt = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(timer_id);
<a name="l00928"></a>00928   <span class="keywordflow">if</span> (pt == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l00929"></a>00929 
<a name="l00930"></a>00930   tcnt = <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec);
<a name="l00931"></a>00931   <span class="keywordflow">if</span> (tcnt == 0) <span class="keywordflow">return</span> osErrorValue;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933   <span class="keywordflow">switch</span> (pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a>) {
<a name="l00934"></a>00934     <span class="keywordflow">case</span> <a class="code" href="rt__CMSIS_8c.html#aa575e7b23afe0438ea73dbb72345da59">osTimerRunning</a>:
<a name="l00935"></a>00935       <span class="keywordflow">if</span> (<a class="code" href="rt__CMSIS_8c.html#a4065ec6b7ff80270913acd949736d506">rt_timer_remove</a>(pt) != 0) {
<a name="l00936"></a>00936         <span class="keywordflow">return</span> osErrorResource;
<a name="l00937"></a>00937       }
<a name="l00938"></a>00938       <span class="keywordflow">break</span>;
<a name="l00939"></a>00939     <span class="keywordflow">case</span> <a class="code" href="rt__CMSIS_8c.html#a269ef354d9e85e536de2a58f44459399">osTimerStopped</a>:
<a name="l00940"></a>00940       pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a> = <a class="code" href="rt__CMSIS_8c.html#aa575e7b23afe0438ea73dbb72345da59">osTimerRunning</a>;
<a name="l00941"></a>00941       pt-&gt;<a class="code" href="structos__timer__cb__.html#ac3902cb8f1f52b6e73206ec5b97e4e48">icnt</a>  = (uint16_t)tcnt;
<a name="l00942"></a>00942       <span class="keywordflow">break</span>;
<a name="l00943"></a>00943     <span class="keywordflow">default</span>:
<a name="l00944"></a>00944       <span class="keywordflow">return</span> osErrorResource;
<a name="l00945"></a>00945   }
<a name="l00946"></a>00946   
<a name="l00947"></a>00947   <a class="code" href="rt__CMSIS_8c.html#a21de0bf1d7f000640f4d49a4f4338fb9">rt_timer_insert</a>(pt, tcnt);
<a name="l00948"></a>00948 
<a name="l00949"></a>00949   <span class="keywordflow">return</span> osOK;
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
<a name="l00953"></a><a class="code" href="rt__CMSIS_8c.html#a88bf6dbc5f80cb5d736548cd3e7cef97">00953</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a88bf6dbc5f80cb5d736548cd3e7cef97" title="Stop timer.">svcTimerStop</a> (osTimerId timer_id) {
<a name="l00954"></a>00954   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956   pt = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(timer_id);
<a name="l00957"></a>00957   <span class="keywordflow">if</span> (pt == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959   <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a> != <a class="code" href="rt__CMSIS_8c.html#aa575e7b23afe0438ea73dbb72345da59">osTimerRunning</a>) <span class="keywordflow">return</span> osErrorResource;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961   pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a> = <a class="code" href="rt__CMSIS_8c.html#a269ef354d9e85e536de2a58f44459399">osTimerStopped</a>;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963   <span class="keywordflow">if</span> (<a class="code" href="rt__CMSIS_8c.html#a4065ec6b7ff80270913acd949736d506">rt_timer_remove</a>(pt) != 0) {
<a name="l00964"></a>00964     <span class="keywordflow">return</span> osErrorResource;
<a name="l00965"></a>00965   }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967   <span class="keywordflow">return</span> osOK;
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00971"></a><a class="code" href="rt__CMSIS_8c.html#a4d052f205759d3face595af827f17463">00971</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a4d052f205759d3face595af827f17463" title="Delete timer.">svcTimerDelete</a> (osTimerId timer_id) {
<a name="l00972"></a>00972   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974   pt = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(timer_id);
<a name="l00975"></a>00975   <span class="keywordflow">if</span> (pt == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <span class="keywordflow">switch</span> (pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a>) {
<a name="l00978"></a>00978     <span class="keywordflow">case</span> <a class="code" href="rt__CMSIS_8c.html#aa575e7b23afe0438ea73dbb72345da59">osTimerRunning</a>:
<a name="l00979"></a>00979       <a class="code" href="rt__CMSIS_8c.html#a4065ec6b7ff80270913acd949736d506">rt_timer_remove</a>(pt);
<a name="l00980"></a>00980       <span class="keywordflow">break</span>;
<a name="l00981"></a>00981     <span class="keywordflow">case</span> <a class="code" href="rt__CMSIS_8c.html#a269ef354d9e85e536de2a58f44459399">osTimerStopped</a>:
<a name="l00982"></a>00982       <span class="keywordflow">break</span>;
<a name="l00983"></a>00983     <span class="keywordflow">default</span>:
<a name="l00984"></a>00984       <span class="keywordflow">return</span> osErrorResource;
<a name="l00985"></a>00985   }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987   pt-&gt;<a class="code" href="structos__timer__cb__.html#a911c48e9e10ebc19775997cec13e4cab">state</a> = <a class="code" href="rt__CMSIS_8c.html#a5f9ab05e8080a71759e439aad84ae5a9">osTimerInvalid</a>;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989   <span class="keywordflow">return</span> osOK;
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00993"></a><a class="code" href="rt__CMSIS_8c.html#af951f809d922f5d81b788d6d2e67aa27">00993</a> os_InRegs osCallback_type <a class="code" href="rt__CMSIS_8c.html#af951f809d922f5d81b788d6d2e67aa27" title="Get timer callback parameters.">svcTimerCall</a> (osTimerId timer_id) {
<a name="l00994"></a>00994   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt;
<a name="l00995"></a>00995   <a class="code" href="structosCallback.html">osCallback</a>   ret;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   pt = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(timer_id);
<a name="l00998"></a>00998   <span class="keywordflow">if</span> (pt == NULL) {
<a name="l00999"></a>00999     ret.<a class="code" href="structosCallback.html#af0638bc58679a5142b3b9f6a0e2f9195">fp</a>  = NULL;
<a name="l01000"></a>01000     ret.<a class="code" href="structosCallback.html#aed18a60ced37a709284f1130a46da51e">arg</a> = NULL;
<a name="l01001"></a>01001     <span class="keywordflow">return</span> osCallback_ret;
<a name="l01002"></a>01002   }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004   ret.<a class="code" href="structosCallback.html#af0638bc58679a5142b3b9f6a0e2f9195">fp</a>  = (<span class="keywordtype">void</span> *)pt-&gt;<a class="code" href="structos__timer__cb__.html#a30fa9f00974beea0d6ba5cb88c8cb1f4">timer</a>-&gt;ptimer;
<a name="l01005"></a>01005   ret.<a class="code" href="structosCallback.html#aed18a60ced37a709284f1130a46da51e">arg</a> = pt-&gt;<a class="code" href="structos__timer__cb__.html#a5407388cba31bfcf592af5479fc0e91b">arg</a>;
<a name="l01006"></a>01006 
<a name="l01007"></a>01007   <span class="keywordflow">return</span> osCallback_ret;
<a name="l01008"></a>01008 }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010 <span class="keyword">static</span> __INLINE osStatus <a class="code" href="rt__CMSIS_8c.html#adac689e705ffb6fb4ed3a7ad16471f09" title="Put a Message to a Queue.">isrMessagePut</a> (osMessageQId queue_id, uint32_t info, uint32_t millisec);
<a name="l01011"></a>01011 
<a name="l01013"></a><a class="code" href="rt__CMSIS_8c.html#a46349cb2b199da8d107881532f1e6136">01013</a> <span class="keywordtype">void</span> <a class="code" href="rt__CMSIS_8c.html#a46349cb2b199da8d107881532f1e6136" title="Timer Tick (called each SysTick)">sysTimerTick</a> (<span class="keywordtype">void</span>) {
<a name="l01014"></a>01014   <a class="code" href="structos__timer__cb__.html">os_timer_cb</a> *pt, *p;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016   p = <a class="code" href="rt__CMSIS_8c.html#a4de6937be649800bd3a62c2b6fb5589e">os_timer_head</a>;
<a name="l01017"></a>01017   <span class="keywordflow">if</span> (p == NULL) <span class="keywordflow">return</span>;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019   p-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a>--;
<a name="l01020"></a>01020   <span class="keywordflow">while</span> ((p != NULL) &amp;&amp; (p-&gt;<a class="code" href="structos__timer__cb__.html#ac4d7410873d537d4e09f540fd9a2ce0e">tcnt</a> == 0)) {
<a name="l01021"></a>01021     pt = p;
<a name="l01022"></a>01022     p = p-&gt;<a class="code" href="structos__timer__cb__.html#a814dc92b9134f1a2bcb5c4209f254037">next</a>;
<a name="l01023"></a>01023     os_timer_head = p;
<a name="l01024"></a>01024     <a class="code" href="rt__CMSIS_8c.html#adac689e705ffb6fb4ed3a7ad16471f09" title="Put a Message to a Queue.">isrMessagePut</a>(osMessageQId_osTimerMessageQ, (uint32_t)pt, 0);
<a name="l01025"></a>01025     <span class="keywordflow">if</span> (pt-&gt;type == osTimerPeriodic) {
<a name="l01026"></a>01026       <a class="code" href="rt__CMSIS_8c.html#a21de0bf1d7f000640f4d49a4f4338fb9">rt_timer_insert</a>(pt, pt-&gt;icnt);
<a name="l01027"></a>01027     } <span class="keywordflow">else</span> {
<a name="l01028"></a>01028       pt-&gt;state = <a class="code" href="rt__CMSIS_8c.html#a269ef354d9e85e536de2a58f44459399">osTimerStopped</a>;
<a name="l01029"></a>01029     }
<a name="l01030"></a>01030   }
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="comment">// Timer Management Public API</span>
<a name="l01035"></a>01035 
<a name="l01037"></a><a class="code" href="rt__CMSIS_8c.html#a12cbe501cd7f1aec940cfeb4d8c73c89">01037</a> osTimerId <a class="code" href="rt__CMSIS_8c.html#a12cbe501cd7f1aec940cfeb4d8c73c89" title="Create timer.">osTimerCreate</a> (osTimerDef_t *timer_def, os_timer_type <a class="code" href="structos__timer__cb__.html#a67fd97273c95f7f577c81c40a50d7752">type</a>, <span class="keywordtype">void</span> *argument) {
<a name="l01038"></a>01038   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l01039"></a>01039   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l01040"></a>01040     <span class="comment">// Privileged and not running</span>
<a name="l01041"></a>01041     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a04035bf8187a3f63df32bb9c38cda4ef" title="Create timer.">svcTimerCreate</a>(timer_def, type, argument);
<a name="l01042"></a>01042   } <span class="keywordflow">else</span> {
<a name="l01043"></a>01043     <span class="keywordflow">return</span> __svcTimerCreate(timer_def, type, argument);
<a name="l01044"></a>01044   }
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01048"></a><a class="code" href="rt__CMSIS_8c.html#a27a797a401b068e2644d1125f22a07ca">01048</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a27a797a401b068e2644d1125f22a07ca" title="Start or restart timer.">osTimerStart</a> (osTimerId timer_id, uint32_t millisec) {
<a name="l01049"></a>01049   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01050"></a>01050   <span class="keywordflow">return</span> __svcTimerStart(timer_id, millisec);
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01054"></a><a class="code" href="rt__CMSIS_8c.html#a58f36b121a812936435cacc6e1e0e091">01054</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a58f36b121a812936435cacc6e1e0e091" title="Stop timer.">osTimerStop</a> (osTimerId timer_id) {
<a name="l01055"></a>01055   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01056"></a>01056   <span class="keywordflow">return</span> __svcTimerStop(timer_id);
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01060"></a><a class="code" href="rt__CMSIS_8c.html#a746b8043d906849bd65e3900fcb483cf">01060</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a746b8043d906849bd65e3900fcb483cf" title="Delete timer.">osTimerDelete</a> (osTimerId timer_id) {
<a name="l01061"></a>01061   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01062"></a>01062   <span class="keywordflow">return</span> __svcTimerDelete(timer_id);
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01067"></a><a class="code" href="rt__CMSIS_8c.html#a34c51428af753dd277d9309e70c73d62">01067</a> os_InRegs <a class="code" href="structosCallback.html">osCallback</a> <a class="code" href="rt__CMSIS_8c.html#a34c51428af753dd277d9309e70c73d62">osTimerCall</a> (osTimerId timer_id) { 
<a name="l01068"></a>01068   <span class="keywordflow">return</span> __svcTimerCall(timer_id); 
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 
<a name="l01072"></a>01072 <span class="comment">// Timer Thread</span>
<a name="l01073"></a><a class="code" href="rt__CMSIS_8c.html#ad9cb29cfe73aa8503e4d072010e39932">01073</a> __NO_RETURN <span class="keywordtype">void</span> <a class="code" href="rt__CMSIS_8c.html#ad9cb29cfe73aa8503e4d072010e39932">osTimerThread</a> (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {
<a name="l01074"></a>01074   <a class="code" href="structosCallback.html">osCallback</a> cb;
<a name="l01075"></a>01075   osEvent    evt;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077   <span class="keywordflow">for</span> (;;) {
<a name="l01078"></a>01078     evt = <a class="code" href="rt__CMSIS_8c.html#adb01ec653d1086f99ba00b4148114ba9" title="Get a Message or Wait for a Message from a Queue.">osMessageGet</a>(osMessageQId_osTimerMessageQ, osWaitForever);
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (evt.status == osEventMessage) {
<a name="l01080"></a>01080       cb = <a class="code" href="rt__CMSIS_8c.html#a34c51428af753dd277d9309e70c73d62">osTimerCall</a>(evt.value.p);
<a name="l01081"></a>01081       <span class="keywordflow">if</span> (cb.<a class="code" href="structosCallback.html#af0638bc58679a5142b3b9f6a0e2f9195">fp</a> != NULL) {
<a name="l01082"></a>01082         (*(os_ptimer)cb.<a class="code" href="structosCallback.html#af0638bc58679a5142b3b9f6a0e2f9195">fp</a>)(cb.<a class="code" href="structosCallback.html#aed18a60ced37a709284f1130a46da51e">arg</a>);
<a name="l01083"></a>01083       }
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085   }
<a name="l01086"></a>01086 }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 <span class="comment">// ==== Signal Management ====</span>
<a name="l01090"></a>01090 
<a name="l01091"></a>01091 <span class="comment">// Signal Service Calls declarations</span>
<a name="l01092"></a>01092 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#a35422b425b1c54aab727322c1e691032" title="Set the specified Signal Flags of an active thread.">svcSignalSet</a>,             int32_t, osThreadId, int32_t,  RET_int32_t)
<a name="l01093"></a>01093 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#adbf6cd2f71d328db201fcef297467c6d" title="Clear the specified Signal Flags of an active thread.">svcSignalClear</a>,           int32_t, osThreadId, int32_t,  RET_int32_t)
<a name="l01094"></a>01094 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a30d58d181838c36a7107c8eb5cf742bb" title="Get Signal Flags status of an active thread.">svcSignalGet</a>,             int32_t, osThreadId,           RET_int32_t)
<a name="l01095"></a>01095 SVC_2_3(<a class="code" href="rt__CMSIS_8c.html#ac9ea74ec20daaf79990ff1eba5e9b921" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">svcSignalWait</a>,  os_InRegs osEvent, int32_t,    uint32_t, RET_osEvent)
<a name="l01096"></a>01096 
<a name="l01097"></a>01097 <span class="comment">// Signal Service Calls</span>
<a name="l01098"></a>01098 
<a name="l01100"></a><a class="code" href="rt__CMSIS_8c.html#a35422b425b1c54aab727322c1e691032">01100</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a35422b425b1c54aab727322c1e691032" title="Set the specified Signal Flags of an active thread.">svcSignalSet</a> (osThreadId thread_id, int32_t signals) {
<a name="l01101"></a>01101   P_TCB   ptcb;
<a name="l01102"></a>01102   int32_t sig;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l01105"></a>01105   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> 0x80000000;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107   <span class="keywordflow">if</span> (signals &amp; (0xFFFFFFFF &lt;&lt; osFeature_Signals)) <span class="keywordflow">return</span> 0x80000000;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109   sig = ptcb-&gt;events;                           <span class="comment">// Previous signal flags</span>
<a name="l01110"></a>01110 
<a name="l01111"></a>01111   rt_evt_set(signals, ptcb-&gt;task_id);           <span class="comment">// Set event flags</span>
<a name="l01112"></a>01112 
<a name="l01113"></a>01113   <span class="keywordflow">return</span> sig;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01117"></a><a class="code" href="rt__CMSIS_8c.html#adbf6cd2f71d328db201fcef297467c6d">01117</a> int32_t <a class="code" href="rt__CMSIS_8c.html#adbf6cd2f71d328db201fcef297467c6d" title="Clear the specified Signal Flags of an active thread.">svcSignalClear</a> (osThreadId thread_id, int32_t signals) {
<a name="l01118"></a>01118   P_TCB   ptcb;
<a name="l01119"></a>01119   int32_t sig;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l01122"></a>01122   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> 0x80000000;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124   <span class="keywordflow">if</span> (signals &amp; (0xFFFFFFFF &lt;&lt; osFeature_Signals)) <span class="keywordflow">return</span> 0x80000000;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126   sig = ptcb-&gt;events;                           <span class="comment">// Previous signal flags</span>
<a name="l01127"></a>01127 
<a name="l01128"></a>01128   rt_evt_clr(signals, ptcb-&gt;task_id);           <span class="comment">// Clear event flags</span>
<a name="l01129"></a>01129 
<a name="l01130"></a>01130   <span class="keywordflow">return</span> sig;
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01134"></a><a class="code" href="rt__CMSIS_8c.html#a30d58d181838c36a7107c8eb5cf742bb">01134</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a30d58d181838c36a7107c8eb5cf742bb" title="Get Signal Flags status of an active thread.">svcSignalGet</a> (osThreadId thread_id) {
<a name="l01135"></a>01135   P_TCB ptcb;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l01138"></a>01138   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> 0x80000000;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140   <span class="keywordflow">return</span> ptcb-&gt;events;                          <span class="comment">// Return event flags</span>
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01144"></a><a class="code" href="rt__CMSIS_8c.html#ac9ea74ec20daaf79990ff1eba5e9b921">01144</a> os_InRegs osEvent_type <a class="code" href="rt__CMSIS_8c.html#ac9ea74ec20daaf79990ff1eba5e9b921" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">svcSignalWait</a> (int32_t signals, uint32_t millisec) {
<a name="l01145"></a>01145   OS_RESULT res;
<a name="l01146"></a>01146   osEvent   ret;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148   <span class="keywordflow">if</span> (signals &amp; (0xFFFFFFFF &lt;&lt; osFeature_Signals)) {
<a name="l01149"></a>01149     ret.status = osErrorValue;
<a name="l01150"></a>01150     <span class="keywordflow">return</span> osEvent_ret_status;
<a name="l01151"></a>01151   }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153   <span class="keywordflow">if</span> (signals != 0) {                           <span class="comment">// Wait for all specified signals</span>
<a name="l01154"></a>01154     res = rt_evt_wait(signals, <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec), __TRUE);
<a name="l01155"></a>01155   } <span class="keywordflow">else</span> {                                      <span class="comment">// Wait for any signal</span>
<a name="l01156"></a>01156     res = rt_evt_wait(0xFFFF,  <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec), __FALSE);
<a name="l01157"></a>01157   }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159   <span class="keywordflow">if</span> (res == OS_R_EVT) {
<a name="l01160"></a>01160     ret.status = osEventSignal;
<a name="l01161"></a>01161     ret.value.signals = signals ? signals : os_tsk.run-&gt;waits;
<a name="l01162"></a>01162   } <span class="keywordflow">else</span> {
<a name="l01163"></a>01163     ret.status = millisec ? osEventTimeout : osOK;
<a name="l01164"></a>01164     ret.value.signals = 0;
<a name="l01165"></a>01165   }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167   <span class="keywordflow">return</span> osEvent_ret_value;
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 <span class="comment">// Signal ISR Calls</span>
<a name="l01172"></a>01172 
<a name="l01174"></a><a class="code" href="rt__CMSIS_8c.html#a37d107c42adc566e4f3b890a49cea2d4">01174</a> <span class="keyword">static</span> __INLINE int32_t <a class="code" href="rt__CMSIS_8c.html#a37d107c42adc566e4f3b890a49cea2d4" title="Set the specified Signal Flags of an active thread.">isrSignalSet</a> (osThreadId thread_id, int32_t signals) {
<a name="l01175"></a>01175   P_TCB   ptcb;
<a name="l01176"></a>01176   int32_t sig;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   ptcb = <a class="code" href="rt__CMSIS_8c.html#a2709bfe61c50c66eda69c25c4925d35c" title="Convert Thread ID to TCB pointer.">rt_tid2ptcb</a>(thread_id);                <span class="comment">// Get TCB pointer</span>
<a name="l01179"></a>01179   <span class="keywordflow">if</span> (ptcb == NULL) <span class="keywordflow">return</span> 0x80000000;
<a name="l01180"></a>01180 
<a name="l01181"></a>01181   <span class="keywordflow">if</span> (signals &amp; (0xFFFFFFFF &lt;&lt; osFeature_Signals)) <span class="keywordflow">return</span> 0x80000000;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183   sig = ptcb-&gt;events;                           <span class="comment">// Previous signal flags</span>
<a name="l01184"></a>01184 
<a name="l01185"></a>01185   isr_evt_set(signals, ptcb-&gt;task_id);          <span class="comment">// Set event flags</span>
<a name="l01186"></a>01186 
<a name="l01187"></a>01187   <span class="keywordflow">return</span> sig;
<a name="l01188"></a>01188 }
<a name="l01189"></a>01189 
<a name="l01190"></a>01190 
<a name="l01191"></a>01191 <span class="comment">// Signal Public API</span>
<a name="l01192"></a>01192 
<a name="l01194"></a><a class="code" href="rt__CMSIS_8c.html#a3de2730654589d6c3559c4b9e2825553">01194</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a3de2730654589d6c3559c4b9e2825553" title="Set the specified Signal Flags of an active thread.">osSignalSet</a> (osThreadId thread_id, int32_t signals) {
<a name="l01195"></a>01195   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01196"></a>01196     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a37d107c42adc566e4f3b890a49cea2d4" title="Set the specified Signal Flags of an active thread.">isrSignalSet</a>(thread_id, signals); 
<a name="l01197"></a>01197   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01198"></a>01198     <span class="keywordflow">return</span> __svcSignalSet(thread_id, signals);
<a name="l01199"></a>01199   }
<a name="l01200"></a>01200 }
<a name="l01201"></a>01201 
<a name="l01203"></a><a class="code" href="rt__CMSIS_8c.html#a87283a6ebc31ce9ed42baf3ea7e4eab6">01203</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a87283a6ebc31ce9ed42baf3ea7e4eab6" title="Clear the specified Signal Flags of an active thread.">osSignalClear</a> (osThreadId thread_id, int32_t signals) {
<a name="l01204"></a>01204   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01205"></a>01205   <span class="keywordflow">return</span> __svcSignalClear(thread_id, signals);
<a name="l01206"></a>01206 }
<a name="l01207"></a>01207 
<a name="l01209"></a><a class="code" href="rt__CMSIS_8c.html#a071c0d1c3bdcac9e75fad0b25a5cd8f1">01209</a> int32_t <a class="code" href="rt__CMSIS_8c.html#a071c0d1c3bdcac9e75fad0b25a5cd8f1" title="Get Signal Flags status of an active thread.">osSignalGet</a> (osThreadId thread_id) {
<a name="l01210"></a>01210   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01211"></a>01211   <span class="keywordflow">return</span> __svcSignalGet(thread_id);
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01215"></a><a class="code" href="rt__CMSIS_8c.html#a74b9d7a26279c8ac4cc246e66cbbad40">01215</a> os_InRegs osEvent <a class="code" href="rt__CMSIS_8c.html#a74b9d7a26279c8ac4cc246e66cbbad40" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">osSignalWait</a> (int32_t signals, uint32_t millisec) {
<a name="l01216"></a>01216   osEvent ret;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// Not allowed in ISR</span>
<a name="l01219"></a>01219     ret.status = osErrorISR;
<a name="l01220"></a>01220     <span class="keywordflow">return</span> ret;
<a name="l01221"></a>01221   }
<a name="l01222"></a>01222   <span class="keywordflow">return</span> __svcSignalWait(signals, millisec);
<a name="l01223"></a>01223 }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225 
<a name="l01226"></a>01226 <span class="comment">// ==== Mutex Management ====</span>
<a name="l01227"></a>01227 
<a name="l01228"></a>01228 <span class="comment">// Mutex Service Calls declarations</span>
<a name="l01229"></a>01229 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#af2fc8ac9b0bfdca0b2ee24d62feddfd5" title="Create and Initialize a Mutex object.">svcMutexCreate</a>,  osMutexId, osMutexDef_t *,           RET_pointer)
<a name="l01230"></a>01230 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#adfdf766208712badbdb214dcaf62a7db" title="Wait until a Mutex becomes available.">svcMutexWait</a>,    osStatus,  osMutexId,      uint32_t, RET_osStatus)
<a name="l01231"></a>01231 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#af173ec3a17189035663d34293b3f715f" title="Release a Mutex that was obtained with osMutexWait.">svcMutexRelease</a>, osStatus,  osMutexId,                RET_osStatus)
<a name="l01232"></a>01232 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a9d1e7856e1f1836bf5694745efbfdc48" title="Delete a Mutex that was created by osMutexCreate.">svcMutexDelete</a>,  osStatus,  osMutexId,                RET_osStatus)
<a name="l01233"></a>01233 
<a name="l01234"></a>01234 <span class="comment">// Mutex Service Calls</span>
<a name="l01235"></a>01235 
<a name="l01237"></a><a class="code" href="rt__CMSIS_8c.html#af2fc8ac9b0bfdca0b2ee24d62feddfd5">01237</a> osMutexId <a class="code" href="rt__CMSIS_8c.html#af2fc8ac9b0bfdca0b2ee24d62feddfd5" title="Create and Initialize a Mutex object.">svcMutexCreate</a> (osMutexDef_t *mutex_def) {
<a name="l01238"></a>01238   OS_ID mut;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240   <span class="keywordflow">if</span> (mutex_def == NULL) {
<a name="l01241"></a>01241     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01242"></a>01242     <span class="keywordflow">return</span> NULL;
<a name="l01243"></a>01243   }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245   mut = mutex_def-&gt;mutex;
<a name="l01246"></a>01246   <span class="keywordflow">if</span> (mut == NULL) {
<a name="l01247"></a>01247     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01248"></a>01248     <span class="keywordflow">return</span> NULL;
<a name="l01249"></a>01249   }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251   <span class="keywordflow">if</span> (((P_MUCB)mut)-&gt;cb_type != 0) {
<a name="l01252"></a>01252     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01253"></a>01253     <span class="keywordflow">return</span> NULL;
<a name="l01254"></a>01254   }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256   rt_mut_init(mut);                             <span class="comment">// Initialize Mutex</span>
<a name="l01257"></a>01257 
<a name="l01258"></a>01258   <span class="keywordflow">return</span> mut;
<a name="l01259"></a>01259 }
<a name="l01260"></a>01260 
<a name="l01262"></a><a class="code" href="rt__CMSIS_8c.html#adfdf766208712badbdb214dcaf62a7db">01262</a> osStatus <a class="code" href="rt__CMSIS_8c.html#adfdf766208712badbdb214dcaf62a7db" title="Wait until a Mutex becomes available.">svcMutexWait</a> (osMutexId mutex_id, uint32_t millisec) {
<a name="l01263"></a>01263   OS_ID     mut;
<a name="l01264"></a>01264   OS_RESULT res;
<a name="l01265"></a>01265 
<a name="l01266"></a>01266   mut = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(mutex_id);
<a name="l01267"></a>01267   <span class="keywordflow">if</span> (mut == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269   <span class="keywordflow">if</span> (((P_MUCB)mut)-&gt;cb_type != MUCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271   res = rt_mut_wait(mut, <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec)); <span class="comment">// Wait for Mutex</span>
<a name="l01272"></a>01272 
<a name="l01273"></a>01273   <span class="keywordflow">if</span> (res == OS_R_TMO) {
<a name="l01274"></a>01274     <span class="keywordflow">return</span> (millisec ? osErrorTimeoutResource : osErrorResource);
<a name="l01275"></a>01275   }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277   <span class="keywordflow">return</span> osOK;
<a name="l01278"></a>01278 }
<a name="l01279"></a>01279 
<a name="l01281"></a><a class="code" href="rt__CMSIS_8c.html#af173ec3a17189035663d34293b3f715f">01281</a> osStatus <a class="code" href="rt__CMSIS_8c.html#af173ec3a17189035663d34293b3f715f" title="Release a Mutex that was obtained with osMutexWait.">svcMutexRelease</a> (osMutexId mutex_id) {
<a name="l01282"></a>01282   OS_ID     mut;
<a name="l01283"></a>01283   OS_RESULT res;
<a name="l01284"></a>01284 
<a name="l01285"></a>01285   mut = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(mutex_id);
<a name="l01286"></a>01286   <span class="keywordflow">if</span> (mut == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288   <span class="keywordflow">if</span> (((P_MUCB)mut)-&gt;cb_type != MUCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290   res = rt_mut_release(mut);                    <span class="comment">// Release Mutex</span>
<a name="l01291"></a>01291 
<a name="l01292"></a>01292   <span class="keywordflow">if</span> (res == OS_R_NOK) <span class="keywordflow">return</span> osErrorResource;  <span class="comment">// Thread not owner or Zero Counter</span>
<a name="l01293"></a>01293 
<a name="l01294"></a>01294   <span class="keywordflow">return</span> osOK;
<a name="l01295"></a>01295 }
<a name="l01296"></a>01296 
<a name="l01298"></a><a class="code" href="rt__CMSIS_8c.html#a9d1e7856e1f1836bf5694745efbfdc48">01298</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a9d1e7856e1f1836bf5694745efbfdc48" title="Delete a Mutex that was created by osMutexCreate.">svcMutexDelete</a> (osMutexId mutex_id) {
<a name="l01299"></a>01299   OS_ID mut;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301   mut = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(mutex_id);
<a name="l01302"></a>01302   <span class="keywordflow">if</span> (mut == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01303"></a>01303 
<a name="l01304"></a>01304   <span class="keywordflow">if</span> (((P_MUCB)mut)-&gt;cb_type != MUCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01305"></a>01305 
<a name="l01306"></a>01306   rt_mut_delete(mut);                           <span class="comment">// Release Mutex</span>
<a name="l01307"></a>01307 
<a name="l01308"></a>01308   <span class="keywordflow">return</span> osOK;
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311 
<a name="l01312"></a>01312 <span class="comment">// Mutex Public API</span>
<a name="l01313"></a>01313 
<a name="l01315"></a><a class="code" href="rt__CMSIS_8c.html#a6356ddcf2e34ada892c57f13b284105e">01315</a> osMutexId <a class="code" href="rt__CMSIS_8c.html#a6356ddcf2e34ada892c57f13b284105e" title="Create and Initialize a Mutex object.">osMutexCreate</a> (osMutexDef_t *mutex_def) {
<a name="l01316"></a>01316   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l01317"></a>01317   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l01318"></a>01318     <span class="comment">// Privileged and not running</span>
<a name="l01319"></a>01319     <span class="keywordflow">return</span>    <a class="code" href="rt__CMSIS_8c.html#af2fc8ac9b0bfdca0b2ee24d62feddfd5" title="Create and Initialize a Mutex object.">svcMutexCreate</a>(mutex_def);
<a name="l01320"></a>01320   } <span class="keywordflow">else</span> {
<a name="l01321"></a>01321     <span class="keywordflow">return</span> __svcMutexCreate(mutex_def);
<a name="l01322"></a>01322   }
<a name="l01323"></a>01323 }
<a name="l01324"></a>01324 
<a name="l01326"></a><a class="code" href="rt__CMSIS_8c.html#a5e1752b73f573ee015dbd9ef1edaba13">01326</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a5e1752b73f573ee015dbd9ef1edaba13" title="Wait until a Mutex becomes available.">osMutexWait</a> (osMutexId mutex_id, uint32_t millisec) {
<a name="l01327"></a>01327   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01328"></a>01328   <span class="keywordflow">return</span> __svcMutexWait(mutex_id, millisec);
<a name="l01329"></a>01329 }
<a name="l01330"></a>01330 
<a name="l01332"></a><a class="code" href="rt__CMSIS_8c.html#a006e4744d741e8e132c3d5bbc295afe1">01332</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a006e4744d741e8e132c3d5bbc295afe1" title="Release a Mutex that was obtained with osMutexWait.">osMutexRelease</a> (osMutexId mutex_id) {
<a name="l01333"></a>01333   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01334"></a>01334   <span class="keywordflow">return</span> __svcMutexRelease(mutex_id);
<a name="l01335"></a>01335 }
<a name="l01336"></a>01336 
<a name="l01338"></a><a class="code" href="rt__CMSIS_8c.html#ac27e24135185d51d18f3dabc20910219">01338</a> osStatus <a class="code" href="rt__CMSIS_8c.html#ac27e24135185d51d18f3dabc20910219" title="Delete a Mutex that was created by osMutexCreate.">osMutexDelete</a> (osMutexId mutex_id) {
<a name="l01339"></a>01339   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01340"></a>01340   <span class="keywordflow">return</span> __svcMutexDelete(mutex_id);
<a name="l01341"></a>01341 }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343 
<a name="l01344"></a>01344 <span class="comment">// ==== Semaphore Management ====</span>
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 <span class="comment">// Semaphore Service Calls declarations</span>
<a name="l01347"></a>01347 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#a3ef4377d348529faeb54a4ac989d1b76" title="Create and Initialize a Semaphore object.">svcSemaphoreCreate</a>,  osSemaphoreId, <span class="keyword">const</span> osSemaphoreDef_t *,  int32_t, RET_pointer)
<a name="l01348"></a>01348 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#aea1f0e7d4cccc3e457318960082bf0a0" title="Wait until a Semaphore becomes available.">svcSemaphoreWait</a>,    int32_t,       osSemaphoreId,      uint32_t, RET_int32_t)
<a name="l01349"></a>01349 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#af712c5abc826bbe22748ee79caa74463" title="Release a Semaphore.">svcSemaphoreRelease</a>, osStatus,      osSemaphoreId,                RET_osStatus)
<a name="l01350"></a>01350 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#ab9c8f909609ead2889906da5e741f346" title="Delete a Semaphore that was created by osSemaphoreCreate.">svcSemaphoreDelete</a>,  osStatus,            osSemaphoreId,                RET_osStatus)
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 <span class="comment">// Semaphore Service Calls</span>
<a name="l01353"></a>01353 
<a name="l01355"></a><a class="code" href="rt__CMSIS_8c.html#a3ef4377d348529faeb54a4ac989d1b76">01355</a> osSemaphoreId <a class="code" href="rt__CMSIS_8c.html#a3ef4377d348529faeb54a4ac989d1b76" title="Create and Initialize a Semaphore object.">svcSemaphoreCreate</a> (const osSemaphoreDef_t *semaphore_def, int32_t count) {
<a name="l01356"></a>01356   OS_ID sem;
<a name="l01357"></a>01357 
<a name="l01358"></a>01358   <span class="keywordflow">if</span> (semaphore_def == NULL) {
<a name="l01359"></a>01359     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01360"></a>01360     <span class="keywordflow">return</span> NULL;
<a name="l01361"></a>01361   }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363   sem = semaphore_def-&gt;semaphore;
<a name="l01364"></a>01364   <span class="keywordflow">if</span> (sem == NULL) {
<a name="l01365"></a>01365     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01366"></a>01366     <span class="keywordflow">return</span> NULL;
<a name="l01367"></a>01367   }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;cb_type != 0) {
<a name="l01370"></a>01370     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01371"></a>01371     <span class="keywordflow">return</span> NULL;
<a name="l01372"></a>01372   }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374   <span class="keywordflow">if</span> (count &gt; osFeature_Semaphore) {
<a name="l01375"></a>01375     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorValue);
<a name="l01376"></a>01376     <span class="keywordflow">return</span> NULL;
<a name="l01377"></a>01377   }
<a name="l01378"></a>01378 
<a name="l01379"></a>01379   rt_sem_init(sem, count);                      <span class="comment">// Initialize Semaphore</span>
<a name="l01380"></a>01380   
<a name="l01381"></a>01381   <span class="keywordflow">return</span> sem;
<a name="l01382"></a>01382 }
<a name="l01383"></a>01383 
<a name="l01385"></a><a class="code" href="rt__CMSIS_8c.html#aea1f0e7d4cccc3e457318960082bf0a0">01385</a> int32_t <a class="code" href="rt__CMSIS_8c.html#aea1f0e7d4cccc3e457318960082bf0a0" title="Wait until a Semaphore becomes available.">svcSemaphoreWait</a> (osSemaphoreId semaphore_id, uint32_t millisec) {
<a name="l01386"></a>01386   OS_ID     sem;
<a name="l01387"></a>01387   OS_RESULT res;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389   sem = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(semaphore_id);
<a name="l01390"></a>01390   <span class="keywordflow">if</span> (sem == NULL) <span class="keywordflow">return</span> -1;
<a name="l01391"></a>01391 
<a name="l01392"></a>01392   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;cb_type != SCB) <span class="keywordflow">return</span> -1;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394   res = rt_sem_wait(sem, <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec)); <span class="comment">// Wait for Semaphore</span>
<a name="l01395"></a>01395 
<a name="l01396"></a>01396   <span class="keywordflow">if</span> (res == OS_R_TMO) <span class="keywordflow">return</span> 0;                <span class="comment">// Timeout</span>
<a name="l01397"></a>01397 
<a name="l01398"></a>01398   <span class="keywordflow">return</span> (((P_SCB)sem)-&gt;tokens + 1);
<a name="l01399"></a>01399 }
<a name="l01400"></a>01400 
<a name="l01402"></a><a class="code" href="rt__CMSIS_8c.html#af712c5abc826bbe22748ee79caa74463">01402</a> osStatus <a class="code" href="rt__CMSIS_8c.html#af712c5abc826bbe22748ee79caa74463" title="Release a Semaphore.">svcSemaphoreRelease</a> (osSemaphoreId semaphore_id) {
<a name="l01403"></a>01403   OS_ID sem;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405   sem = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(semaphore_id);
<a name="l01406"></a>01406   <span class="keywordflow">if</span> (sem == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01407"></a>01407 
<a name="l01408"></a>01408   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;cb_type != SCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01409"></a>01409 
<a name="l01410"></a>01410   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;tokens == osFeature_Semaphore) <span class="keywordflow">return</span> osErrorResource;
<a name="l01411"></a>01411   
<a name="l01412"></a>01412   rt_sem_send(sem);                             <span class="comment">// Release Semaphore</span>
<a name="l01413"></a>01413 
<a name="l01414"></a>01414   <span class="keywordflow">return</span> osOK;
<a name="l01415"></a>01415 }
<a name="l01416"></a>01416 
<a name="l01418"></a><a class="code" href="rt__CMSIS_8c.html#ab9c8f909609ead2889906da5e741f346">01418</a> osStatus <a class="code" href="rt__CMSIS_8c.html#ab9c8f909609ead2889906da5e741f346" title="Delete a Semaphore that was created by osSemaphoreCreate.">svcSemaphoreDelete</a> (osSemaphoreId semaphore_id) {
<a name="l01419"></a>01419   OS_ID sem;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421   sem = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(semaphore_id);
<a name="l01422"></a>01422   <span class="keywordflow">if</span> (sem == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;cb_type != SCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426   rt_sem_delete(sem);                           <span class="comment">// Delete Semaphore</span>
<a name="l01427"></a>01427 
<a name="l01428"></a>01428   <span class="keywordflow">return</span> osOK;
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431 
<a name="l01432"></a>01432 <span class="comment">// Semaphore ISR Calls</span>
<a name="l01433"></a>01433 
<a name="l01435"></a><a class="code" href="rt__CMSIS_8c.html#a9918065f6e6fede73c3c94ecebdf5a16">01435</a> <span class="keyword">static</span> __INLINE osStatus <a class="code" href="rt__CMSIS_8c.html#a9918065f6e6fede73c3c94ecebdf5a16" title="Release a Semaphore.">isrSemaphoreRelease</a> (osSemaphoreId semaphore_id) {
<a name="l01436"></a>01436   OS_ID sem;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438   sem = <a class="code" href="rt__CMSIS_8c.html#ab8fcdac29d446c7b713ee678cf224ba4" title="Convert ID pointer to Object pointer.">rt_id2obj</a>(semaphore_id);
<a name="l01439"></a>01439   <span class="keywordflow">if</span> (sem == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;cb_type != SCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01442"></a>01442 
<a name="l01443"></a>01443   <span class="keywordflow">if</span> (((P_SCB)sem)-&gt;tokens == osFeature_Semaphore) <span class="keywordflow">return</span> osErrorResource;
<a name="l01444"></a>01444 
<a name="l01445"></a>01445   isr_sem_send(sem);                            <span class="comment">// Release Semaphore</span>
<a name="l01446"></a>01446 
<a name="l01447"></a>01447   <span class="keywordflow">return</span> osOK;
<a name="l01448"></a>01448 }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 <span class="comment">// Semaphore Public API</span>
<a name="l01452"></a>01452 
<a name="l01454"></a><a class="code" href="rt__CMSIS_8c.html#a5ede9e5c5c3747cae928ff4f9d13e76d">01454</a> osSemaphoreId <a class="code" href="rt__CMSIS_8c.html#a5ede9e5c5c3747cae928ff4f9d13e76d" title="Create and Initialize a Semaphore object.">osSemaphoreCreate</a> (osSemaphoreDef_t *semaphore_def, int32_t count) {
<a name="l01455"></a>01455   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l01456"></a>01456   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l01457"></a>01457     <span class="comment">// Privileged and not running</span>
<a name="l01458"></a>01458     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a3ef4377d348529faeb54a4ac989d1b76" title="Create and Initialize a Semaphore object.">svcSemaphoreCreate</a>(semaphore_def, count);
<a name="l01459"></a>01459   } <span class="keywordflow">else</span> {
<a name="l01460"></a>01460     <span class="keywordflow">return</span> __svcSemaphoreCreate(semaphore_def, count);
<a name="l01461"></a>01461   }
<a name="l01462"></a>01462 }
<a name="l01463"></a>01463 
<a name="l01465"></a><a class="code" href="rt__CMSIS_8c.html#acc15b0fc8ce1167fe43da33042e62098">01465</a> int32_t <a class="code" href="rt__CMSIS_8c.html#acc15b0fc8ce1167fe43da33042e62098" title="Wait until a Semaphore becomes available.">osSemaphoreWait</a> (osSemaphoreId semaphore_id, uint32_t millisec) {
<a name="l01466"></a>01466   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> -1;             <span class="comment">// Not allowed in ISR</span>
<a name="l01467"></a>01467   <span class="keywordflow">return</span> __svcSemaphoreWait(semaphore_id, millisec);
<a name="l01468"></a>01468 }
<a name="l01469"></a>01469 
<a name="l01471"></a><a class="code" href="rt__CMSIS_8c.html#ab108914997c49e14d8ff1ae0d1988ca0">01471</a> osStatus <a class="code" href="rt__CMSIS_8c.html#ab108914997c49e14d8ff1ae0d1988ca0" title="Release a Semaphore.">osSemaphoreRelease</a> (osSemaphoreId semaphore_id) {
<a name="l01472"></a>01472   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01473"></a>01473     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a9918065f6e6fede73c3c94ecebdf5a16" title="Release a Semaphore.">isrSemaphoreRelease</a>(semaphore_id);
<a name="l01474"></a>01474   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01475"></a>01475     <span class="keywordflow">return</span> __svcSemaphoreRelease(semaphore_id);
<a name="l01476"></a>01476   }
<a name="l01477"></a>01477 }
<a name="l01478"></a>01478 
<a name="l01480"></a><a class="code" href="rt__CMSIS_8c.html#abae2801ac2c096f6e8c69a264908f595">01480</a> osStatus <a class="code" href="rt__CMSIS_8c.html#abae2801ac2c096f6e8c69a264908f595" title="Delete a Semaphore that was created by osSemaphoreCreate.">osSemaphoreDelete</a> (osSemaphoreId semaphore_id) {
<a name="l01481"></a>01481   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> osErrorISR;     <span class="comment">// Not allowed in ISR</span>
<a name="l01482"></a>01482   <span class="keywordflow">return</span> __svcSemaphoreDelete(semaphore_id);
<a name="l01483"></a>01483 }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485 
<a name="l01486"></a>01486 <span class="comment">// ==== Memory Management Functions ====</span>
<a name="l01487"></a>01487 
<a name="l01488"></a>01488 <span class="comment">// Memory Management Helper Functions</span>
<a name="l01489"></a>01489 
<a name="l01490"></a>01490 <span class="comment">// Clear Memory Box (Zero init)</span>
<a name="l01491"></a><a class="code" href="rt__CMSIS_8c.html#a25cf234f6d60afd9d5a6e00817a4c38c">01491</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rt__CMSIS_8c.html#a25cf234f6d60afd9d5a6e00817a4c38c">rt_clr_box</a> (<span class="keywordtype">void</span> *box_mem, <span class="keywordtype">void</span> *box) {
<a name="l01492"></a>01492   uint32_t *p, n;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494   <span class="keywordflow">if</span> (box) {
<a name="l01495"></a>01495     p = box;
<a name="l01496"></a>01496     <span class="keywordflow">for</span> (n = ((P_BM)box_mem)-&gt;blk_size; n; n -= 4) {
<a name="l01497"></a>01497       *p++ = 0;
<a name="l01498"></a>01498     }
<a name="l01499"></a>01499   }
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502 <span class="comment">// Memory Management Service Calls declarations</span>
<a name="l01503"></a>01503 SVC_1_1(<a class="code" href="rt__CMSIS_8c.html#a6f8bc4c03e77161efce6be8a6669c317" title="Create and Initialize memory pool.">svcPoolCreate</a>, osPoolId, <span class="keyword">const</span> osPoolDef_t *,           RET_pointer)
<a name="l01504"></a>01504 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#af0689ba6339ba914607443281cf839a3" title="Allocate a memory block from a memory pool.">sysPoolAlloc</a>,  <span class="keywordtype">void</span> *,   osPoolId,      uint32_t, RET_pointer)
<a name="l01505"></a>01505 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#a514ad797caf73e9fd4098948b67489dd" title="Return an allocated memory block back to a specific memory pool.">sysPoolFree</a>,   osStatus, osPoolId,      <span class="keywordtype">void</span> *,   RET_osStatus)
<a name="l01506"></a>01506 
<a name="l01507"></a>01507 <span class="comment">// Memory Management Service &amp; ISR Calls</span>
<a name="l01508"></a>01508 
<a name="l01510"></a><a class="code" href="rt__CMSIS_8c.html#a6f8bc4c03e77161efce6be8a6669c317">01510</a> osPoolId <a class="code" href="rt__CMSIS_8c.html#a6f8bc4c03e77161efce6be8a6669c317" title="Create and Initialize memory pool.">svcPoolCreate</a> (const osPoolDef_t *pool_def) {
<a name="l01511"></a>01511   uint32_t blk_sz;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513   <span class="keywordflow">if</span> ((pool_def == NULL) ||
<a name="l01514"></a>01514       (pool_def-&gt;pool_sz == 0) ||
<a name="l01515"></a>01515       (pool_def-&gt;item_sz == 0) ||
<a name="l01516"></a>01516       (pool_def-&gt;pool == NULL)) {
<a name="l01517"></a>01517     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01518"></a>01518     <span class="keywordflow">return</span> NULL;
<a name="l01519"></a>01519   }
<a name="l01520"></a>01520 
<a name="l01521"></a>01521   blk_sz = (pool_def-&gt;item_sz + 3) &amp; ~3;
<a name="l01522"></a>01522 
<a name="l01523"></a>01523   _init_box(pool_def-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> OS_BM) + pool_def-&gt;pool_sz * blk_sz, blk_sz);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525   <span class="keywordflow">return</span> pool_def-&gt;pool;
<a name="l01526"></a>01526 }
<a name="l01527"></a>01527 
<a name="l01529"></a><a class="code" href="rt__CMSIS_8c.html#af0689ba6339ba914607443281cf839a3">01529</a> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#af0689ba6339ba914607443281cf839a3" title="Allocate a memory block from a memory pool.">sysPoolAlloc</a> (osPoolId pool_id, uint32_t clr) {
<a name="l01530"></a>01530   <span class="keywordtype">void</span> *ptr;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532   <span class="keywordflow">if</span> (pool_id == NULL) <span class="keywordflow">return</span> NULL;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534   ptr = rt_alloc_box(pool_id);
<a name="l01535"></a>01535   <span class="keywordflow">if</span> (clr) {
<a name="l01536"></a>01536     <a class="code" href="rt__CMSIS_8c.html#a25cf234f6d60afd9d5a6e00817a4c38c">rt_clr_box</a>(pool_id, ptr);
<a name="l01537"></a>01537   }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539   <span class="keywordflow">return</span> ptr;
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01543"></a><a class="code" href="rt__CMSIS_8c.html#a514ad797caf73e9fd4098948b67489dd">01543</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a514ad797caf73e9fd4098948b67489dd" title="Return an allocated memory block back to a specific memory pool.">sysPoolFree</a> (osPoolId pool_id, <span class="keywordtype">void</span> *block) {
<a name="l01544"></a>01544   int32_t res;
<a name="l01545"></a>01545     
<a name="l01546"></a>01546   <span class="keywordflow">if</span> (pool_id == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01547"></a>01547 
<a name="l01548"></a>01548   res = rt_free_box(pool_id, block);
<a name="l01549"></a>01549   <span class="keywordflow">if</span> (res != 0) <span class="keywordflow">return</span> osErrorValue;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551   <span class="keywordflow">return</span> osOK;
<a name="l01552"></a>01552 }
<a name="l01553"></a>01553 
<a name="l01554"></a>01554 
<a name="l01555"></a>01555 <span class="comment">// Memory Management Public API</span>
<a name="l01556"></a>01556 
<a name="l01558"></a><a class="code" href="rt__CMSIS_8c.html#a2e265bdc4fcd4f001e34c9321be16d6f">01558</a> osPoolId <a class="code" href="rt__CMSIS_8c.html#a2e265bdc4fcd4f001e34c9321be16d6f" title="Create and Initialize memory pool.">osPoolCreate</a> (osPoolDef_t *pool_def) {
<a name="l01559"></a>01559   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l01560"></a>01560   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l01561"></a>01561     <span class="comment">// Privileged and not running</span>
<a name="l01562"></a>01562     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a6f8bc4c03e77161efce6be8a6669c317" title="Create and Initialize memory pool.">svcPoolCreate</a>(pool_def);
<a name="l01563"></a>01563   } <span class="keywordflow">else</span> {
<a name="l01564"></a>01564     <span class="keywordflow">return</span> __svcPoolCreate(pool_def);
<a name="l01565"></a>01565   }
<a name="l01566"></a>01566 }
<a name="l01567"></a>01567 
<a name="l01569"></a><a class="code" href="rt__CMSIS_8c.html#ab4bc93bf17f94ca99363e53e1a763fb5">01569</a> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#ab4bc93bf17f94ca99363e53e1a763fb5" title="Allocate a memory block from a memory pool.">osPoolAlloc</a> (osPoolId pool_id) {
<a name="l01570"></a>01570   <span class="keywordflow">if</span> ((__get_IPSR() != 0) || ((__get_CONTROL() &amp; 1) == 0)) {    <span class="comment">// in ISR or Privileged</span>
<a name="l01571"></a>01571     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#af0689ba6339ba914607443281cf839a3" title="Allocate a memory block from a memory pool.">sysPoolAlloc</a>(pool_id, 0);
<a name="l01572"></a>01572   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01573"></a>01573     <span class="keywordflow">return</span> __sysPoolAlloc(pool_id, 0);
<a name="l01574"></a>01574   }
<a name="l01575"></a>01575 }
<a name="l01576"></a>01576 
<a name="l01578"></a><a class="code" href="rt__CMSIS_8c.html#ab22c2f194e0f0b05494aa0e9c97d7a51">01578</a> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#ab22c2f194e0f0b05494aa0e9c97d7a51" title="Allocate a memory block from a memory pool and set memory block to zero.">osPoolCAlloc</a> (osPoolId pool_id) {
<a name="l01579"></a>01579   <span class="keywordflow">if</span> ((__get_IPSR() != 0) || ((__get_CONTROL() &amp; 1) == 0)) {    <span class="comment">// in ISR or Privileged</span>
<a name="l01580"></a>01580     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#af0689ba6339ba914607443281cf839a3" title="Allocate a memory block from a memory pool.">sysPoolAlloc</a>(pool_id, 1);
<a name="l01581"></a>01581   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01582"></a>01582     <span class="keywordflow">return</span> __sysPoolAlloc(pool_id, 1);
<a name="l01583"></a>01583   }
<a name="l01584"></a>01584 }
<a name="l01585"></a>01585 
<a name="l01587"></a><a class="code" href="rt__CMSIS_8c.html#a4a861e9c469c9d0daf5721bf174f8e54">01587</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a4a861e9c469c9d0daf5721bf174f8e54" title="Return an allocated memory block back to a specific memory pool.">osPoolFree</a> (osPoolId pool_id, <span class="keywordtype">void</span> *block) {
<a name="l01588"></a>01588   <span class="keywordflow">if</span> ((__get_IPSR() != 0) || ((__get_CONTROL() &amp; 1) == 0)) {    <span class="comment">// in ISR or Privileged</span>
<a name="l01589"></a>01589     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a514ad797caf73e9fd4098948b67489dd" title="Return an allocated memory block back to a specific memory pool.">sysPoolFree</a>(pool_id, block);
<a name="l01590"></a>01590   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01591"></a>01591     <span class="keywordflow">return</span> __sysPoolFree(pool_id, block);
<a name="l01592"></a>01592   }
<a name="l01593"></a>01593 }
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 <span class="comment">// ==== Message Queue Management Functions ====</span>
<a name="l01597"></a>01597 
<a name="l01598"></a>01598 <span class="comment">// Message Queue Management Service Calls declarations</span>
<a name="l01599"></a>01599 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#a5b0709a1f60ee15cb01b11579d0b2981" title="Create and Initialize Message Queue.">svcMessageCreate</a>,        osMessageQId,    osMessageQDef_t *, osThreadId,           RET_pointer)
<a name="l01600"></a>01600 SVC_3_1(<a class="code" href="rt__CMSIS_8c.html#a2b2f5d3e889d9cfd164fc85964ac2280" title="Put a Message to a Queue.">svcMessagePut</a>,              osStatus,     osMessageQId,      uint32_t,   uint32_t, RET_osStatus)
<a name="l01601"></a>01601 SVC_2_3(<a class="code" href="rt__CMSIS_8c.html#aec966d0fa817efc555d20388d04265a3" title="Get a Message or Wait for a Message from a Queue.">svcMessageGet</a>,    os_InRegs osEvent,      osMessageQId,      uint32_t,             RET_osEvent)
<a name="l01602"></a>01602 
<a name="l01603"></a>01603 <span class="comment">// Message Queue Service Calls</span>
<a name="l01604"></a>01604 
<a name="l01606"></a><a class="code" href="rt__CMSIS_8c.html#a5b0709a1f60ee15cb01b11579d0b2981">01606</a> osMessageQId <a class="code" href="rt__CMSIS_8c.html#a5b0709a1f60ee15cb01b11579d0b2981" title="Create and Initialize Message Queue.">svcMessageCreate</a> (osMessageQDef_t *queue_def, osThreadId thread_id) {
<a name="l01607"></a>01607 
<a name="l01608"></a>01608   <span class="keywordflow">if</span> ((queue_def == NULL) ||
<a name="l01609"></a>01609       (queue_def-&gt;queue_sz == 0) ||
<a name="l01610"></a>01610       (queue_def-&gt;pool == NULL)) {
<a name="l01611"></a>01611     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01612"></a>01612     <span class="keywordflow">return</span> NULL;
<a name="l01613"></a>01613   }
<a name="l01614"></a>01614   
<a name="l01615"></a>01615   <span class="keywordflow">if</span> (((P_MCB)queue_def-&gt;pool)-&gt;cb_type != 0) {
<a name="l01616"></a>01616     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01617"></a>01617     <span class="keywordflow">return</span> NULL;
<a name="l01618"></a>01618   }
<a name="l01619"></a>01619 
<a name="l01620"></a>01620   rt_mbx_init(queue_def-&gt;pool, 4*(queue_def-&gt;queue_sz + 4));
<a name="l01621"></a>01621 
<a name="l01622"></a>01622   <span class="keywordflow">return</span> queue_def-&gt;pool;
<a name="l01623"></a>01623 }
<a name="l01624"></a>01624 
<a name="l01626"></a><a class="code" href="rt__CMSIS_8c.html#a2b2f5d3e889d9cfd164fc85964ac2280">01626</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a2b2f5d3e889d9cfd164fc85964ac2280" title="Put a Message to a Queue.">svcMessagePut</a> (osMessageQId queue_id, uint32_t info, uint32_t millisec) {
<a name="l01627"></a>01627   OS_RESULT res;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629   <span class="keywordflow">if</span> (queue_id == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631   <span class="keywordflow">if</span> (((P_MCB)queue_id)-&gt;cb_type != MCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01632"></a>01632 
<a name="l01633"></a>01633   res = rt_mbx_send(queue_id, (<span class="keywordtype">void</span> *)info, <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec));
<a name="l01634"></a>01634 
<a name="l01635"></a>01635   <span class="keywordflow">if</span> (res == OS_R_TMO) {
<a name="l01636"></a>01636     <span class="keywordflow">return</span> (millisec ? osErrorTimeoutResource : osErrorResource);
<a name="l01637"></a>01637   }
<a name="l01638"></a>01638 
<a name="l01639"></a>01639   <span class="keywordflow">return</span> osOK;
<a name="l01640"></a>01640 }
<a name="l01641"></a>01641 
<a name="l01643"></a><a class="code" href="rt__CMSIS_8c.html#aec966d0fa817efc555d20388d04265a3">01643</a> os_InRegs osEvent_type <a class="code" href="rt__CMSIS_8c.html#aec966d0fa817efc555d20388d04265a3" title="Get a Message or Wait for a Message from a Queue.">svcMessageGet</a> (osMessageQId queue_id, uint32_t millisec) {
<a name="l01644"></a>01644   OS_RESULT res;
<a name="l01645"></a>01645   osEvent   ret;
<a name="l01646"></a>01646 
<a name="l01647"></a>01647   <span class="keywordflow">if</span> (queue_id == NULL) {
<a name="l01648"></a>01648     ret.status = osErrorParameter;
<a name="l01649"></a>01649     <span class="keywordflow">return</span> osEvent_ret_status;
<a name="l01650"></a>01650   }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652   <span class="keywordflow">if</span> (((P_MCB)queue_id)-&gt;cb_type != MCB) {
<a name="l01653"></a>01653     ret.status = osErrorParameter;
<a name="l01654"></a>01654     <span class="keywordflow">return</span> osEvent_ret_status;
<a name="l01655"></a>01655   }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657   res = rt_mbx_wait(queue_id, &amp;ret.value.p, <a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec));
<a name="l01658"></a>01658   
<a name="l01659"></a>01659   <span class="keywordflow">if</span> (res == OS_R_TMO) {
<a name="l01660"></a>01660     ret.status = millisec ? osEventTimeout : osOK;
<a name="l01661"></a>01661     <span class="keywordflow">return</span> osEvent_ret_value;
<a name="l01662"></a>01662   }
<a name="l01663"></a>01663 
<a name="l01664"></a>01664   ret.status = osEventMessage;
<a name="l01665"></a>01665 
<a name="l01666"></a>01666   <span class="keywordflow">return</span> osEvent_ret_value;
<a name="l01667"></a>01667 }
<a name="l01668"></a>01668 
<a name="l01669"></a>01669 
<a name="l01670"></a>01670 <span class="comment">// Message Queue ISR Calls</span>
<a name="l01671"></a>01671 
<a name="l01673"></a><a class="code" href="rt__CMSIS_8c.html#adac689e705ffb6fb4ed3a7ad16471f09">01673</a> <span class="keyword">static</span> __INLINE osStatus <a class="code" href="rt__CMSIS_8c.html#adac689e705ffb6fb4ed3a7ad16471f09" title="Put a Message to a Queue.">isrMessagePut</a> (osMessageQId queue_id, uint32_t info, uint32_t millisec) {
<a name="l01674"></a>01674 
<a name="l01675"></a>01675   <span class="keywordflow">if</span> ((queue_id == NULL) || (millisec != 0)) {
<a name="l01676"></a>01676     <span class="keywordflow">return</span> osErrorParameter;
<a name="l01677"></a>01677   }
<a name="l01678"></a>01678 
<a name="l01679"></a>01679   <span class="keywordflow">if</span> (((P_MCB)queue_id)-&gt;cb_type != MCB) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   <span class="keywordflow">if</span> (rt_mbx_check(queue_id) == 0) {            <span class="comment">// Check if Queue is full</span>
<a name="l01682"></a>01682     <span class="keywordflow">return</span> osErrorResource;
<a name="l01683"></a>01683   }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685   isr_mbx_send(queue_id, (<span class="keywordtype">void</span> *)info);
<a name="l01686"></a>01686 
<a name="l01687"></a>01687   <span class="keywordflow">return</span> osOK;
<a name="l01688"></a>01688 }
<a name="l01689"></a>01689 
<a name="l01691"></a><a class="code" href="rt__CMSIS_8c.html#ac8ca0535dd8a17048690955d5a5bb3c4">01691</a> <span class="keyword">static</span> __INLINE os_InRegs osEvent <a class="code" href="rt__CMSIS_8c.html#ac8ca0535dd8a17048690955d5a5bb3c4" title="Get a Message or Wait for a Message from a Queue.">isrMessageGet</a> (osMessageQId queue_id, uint32_t millisec) {
<a name="l01692"></a>01692   OS_RESULT res;
<a name="l01693"></a>01693   osEvent   ret;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695   <span class="keywordflow">if</span> ((queue_id == NULL) || (millisec != 0)) {
<a name="l01696"></a>01696     ret.status = osErrorParameter;
<a name="l01697"></a>01697     <span class="keywordflow">return</span> ret;
<a name="l01698"></a>01698   }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700   <span class="keywordflow">if</span> (((P_MCB)queue_id)-&gt;cb_type != MCB) {
<a name="l01701"></a>01701     ret.status = osErrorParameter;
<a name="l01702"></a>01702     <span class="keywordflow">return</span> ret;
<a name="l01703"></a>01703   }
<a name="l01704"></a>01704 
<a name="l01705"></a>01705   res = isr_mbx_receive(queue_id, &amp;ret.value.p);
<a name="l01706"></a>01706   
<a name="l01707"></a>01707   <span class="keywordflow">if</span> (res != OS_R_MBX) {
<a name="l01708"></a>01708     ret.status = osOK;
<a name="l01709"></a>01709     <span class="keywordflow">return</span> ret;
<a name="l01710"></a>01710   }
<a name="l01711"></a>01711 
<a name="l01712"></a>01712   ret.status = osEventMessage; 
<a name="l01713"></a>01713 
<a name="l01714"></a>01714   <span class="keywordflow">return</span> ret;
<a name="l01715"></a>01715 }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717 
<a name="l01718"></a>01718 <span class="comment">// Message Queue Management Public API</span>
<a name="l01719"></a>01719 
<a name="l01721"></a><a class="code" href="rt__CMSIS_8c.html#ad2d08f3d9250d19b045c83762b7b599f">01721</a> osMessageQId <a class="code" href="rt__CMSIS_8c.html#ad2d08f3d9250d19b045c83762b7b599f" title="Create and Initialize Message Queue.">osMessageCreate</a> (osMessageQDef_t *queue_def, osThreadId thread_id) {
<a name="l01722"></a>01722   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l01723"></a>01723   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l01724"></a>01724     <span class="comment">// Privileged and not running</span>
<a name="l01725"></a>01725     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a5b0709a1f60ee15cb01b11579d0b2981" title="Create and Initialize Message Queue.">svcMessageCreate</a>(queue_def, thread_id);
<a name="l01726"></a>01726   } <span class="keywordflow">else</span> {
<a name="l01727"></a>01727     <span class="keywordflow">return</span> __svcMessageCreate(queue_def, thread_id);
<a name="l01728"></a>01728   }
<a name="l01729"></a>01729 }
<a name="l01730"></a>01730 
<a name="l01732"></a><a class="code" href="rt__CMSIS_8c.html#ac0dcf462fc92de8ffaba6cc004514a6d">01732</a> osStatus <a class="code" href="rt__CMSIS_8c.html#ac0dcf462fc92de8ffaba6cc004514a6d" title="Put a Message to a Queue.">osMessagePut</a> (osMessageQId queue_id, uint32_t info, uint32_t millisec) {
<a name="l01733"></a>01733   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01734"></a>01734     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#adac689e705ffb6fb4ed3a7ad16471f09" title="Put a Message to a Queue.">isrMessagePut</a>(queue_id, info, millisec);
<a name="l01735"></a>01735   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01736"></a>01736     <span class="keywordflow">return</span> __svcMessagePut(queue_id, info, millisec);
<a name="l01737"></a>01737   }
<a name="l01738"></a>01738 }
<a name="l01739"></a>01739 
<a name="l01741"></a><a class="code" href="rt__CMSIS_8c.html#adb01ec653d1086f99ba00b4148114ba9">01741</a> os_InRegs osEvent <a class="code" href="rt__CMSIS_8c.html#adb01ec653d1086f99ba00b4148114ba9" title="Get a Message or Wait for a Message from a Queue.">osMessageGet</a> (osMessageQId queue_id, uint32_t millisec) {
<a name="l01742"></a>01742   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01743"></a>01743     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#ac8ca0535dd8a17048690955d5a5bb3c4" title="Get a Message or Wait for a Message from a Queue.">isrMessageGet</a>(queue_id, millisec);
<a name="l01744"></a>01744   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01745"></a>01745     <span class="keywordflow">return</span> __svcMessageGet(queue_id, millisec);
<a name="l01746"></a>01746   }
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 
<a name="l01750"></a>01750 <span class="comment">// ==== Mail Queue Management Functions ====</span>
<a name="l01751"></a>01751 
<a name="l01752"></a>01752 <span class="comment">// Mail Queue Management Service Calls declarations</span>
<a name="l01753"></a>01753 SVC_2_1(<a class="code" href="rt__CMSIS_8c.html#aa82c01ddb691152284155e93e502e9dc" title="Create and Initialize mail queue.">svcMailCreate</a>, osMailQId, osMailQDef_t *, osThreadId,                   RET_pointer)
<a name="l01754"></a>01754 SVC_4_1(<a class="code" href="rt__CMSIS_8c.html#a3451f199e4795ce3ce8b048bb6a94d24" title="Allocate a memory block from a mail.">sysMailAlloc</a>,  <span class="keywordtype">void</span> *,    osMailQId,      uint32_t, uint32_t, uint32_t, RET_pointer)
<a name="l01755"></a>01755 SVC_3_1(<a class="code" href="rt__CMSIS_8c.html#a06c419addafdbdcf29714f73081cf74f" title="Free a memory block from a mail.">sysMailFree</a>,   osStatus,  osMailQId,      <span class="keywordtype">void</span> *,   uint32_t,           RET_osStatus)
<a name="l01756"></a>01756 
<a name="l01757"></a>01757 <span class="comment">// Mail Queue Management Service &amp; ISR Calls</span>
<a name="l01758"></a>01758 
<a name="l01760"></a><a class="code" href="rt__CMSIS_8c.html#aa82c01ddb691152284155e93e502e9dc">01760</a> osMailQId <a class="code" href="rt__CMSIS_8c.html#aa82c01ddb691152284155e93e502e9dc" title="Create and Initialize mail queue.">svcMailCreate</a> (osMailQDef_t *queue_def, osThreadId thread_id) {
<a name="l01761"></a>01761   uint32_t blk_sz;
<a name="l01762"></a>01762   P_MCB    pmcb;
<a name="l01763"></a>01763   <span class="keywordtype">void</span>    *pool;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765   <span class="keywordflow">if</span> ((queue_def == NULL) ||
<a name="l01766"></a>01766       (queue_def-&gt;queue_sz == 0) ||
<a name="l01767"></a>01767       (queue_def-&gt;item_sz  == 0) ||
<a name="l01768"></a>01768       (queue_def-&gt;pool == NULL)) {
<a name="l01769"></a>01769     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01770"></a>01770     <span class="keywordflow">return</span> NULL;
<a name="l01771"></a>01771   }
<a name="l01772"></a>01772 
<a name="l01773"></a>01773   pmcb = *(((<span class="keywordtype">void</span> **)queue_def-&gt;pool) + 0);
<a name="l01774"></a>01774   pool = *(((<span class="keywordtype">void</span> **)queue_def-&gt;pool) + 1);
<a name="l01775"></a>01775 
<a name="l01776"></a>01776   <span class="keywordflow">if</span> ((pool == NULL) || (pmcb == NULL) || (pmcb-&gt;cb_type != 0)) {
<a name="l01777"></a>01777     <a class="code" href="rt__CMSIS_8c.html#aa1db2f476e726aab866af9391d820e7c">sysThreadError</a>(osErrorParameter);
<a name="l01778"></a>01778     <span class="keywordflow">return</span> NULL;
<a name="l01779"></a>01779   }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781   blk_sz = (queue_def-&gt;item_sz + 3) &amp; ~3;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783   _init_box(pool, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> OS_BM) + queue_def-&gt;queue_sz * blk_sz, blk_sz);
<a name="l01784"></a>01784 
<a name="l01785"></a>01785   rt_mbx_init(pmcb, 4*(queue_def-&gt;queue_sz + 4));
<a name="l01786"></a>01786 
<a name="l01787"></a>01787 
<a name="l01788"></a>01788   <span class="keywordflow">return</span> queue_def-&gt;pool;
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01792"></a><a class="code" href="rt__CMSIS_8c.html#a3451f199e4795ce3ce8b048bb6a94d24">01792</a> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#a3451f199e4795ce3ce8b048bb6a94d24" title="Allocate a memory block from a mail.">sysMailAlloc</a> (osMailQId queue_id, uint32_t millisec, uint32_t isr, uint32_t clr) {
<a name="l01793"></a>01793   P_MCB pmcb;
<a name="l01794"></a>01794   <span class="keywordtype">void</span> *pool;
<a name="l01795"></a>01795   <span class="keywordtype">void</span> *mem;
<a name="l01796"></a>01796 
<a name="l01797"></a>01797   <span class="keywordflow">if</span> (queue_id == NULL) <span class="keywordflow">return</span> NULL;
<a name="l01798"></a>01798 
<a name="l01799"></a>01799   pmcb = *(((<span class="keywordtype">void</span> **)queue_id) + 0);
<a name="l01800"></a>01800   pool = *(((<span class="keywordtype">void</span> **)queue_id) + 1);
<a name="l01801"></a>01801 
<a name="l01802"></a>01802   <span class="keywordflow">if</span> ((pool == NULL) || (pmcb == NULL)) <span class="keywordflow">return</span> NULL;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804   <span class="keywordflow">if</span> (isr &amp;&amp; (millisec != 0)) <span class="keywordflow">return</span> NULL;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806   mem = rt_alloc_box(pool);
<a name="l01807"></a>01807   <span class="keywordflow">if</span> (clr) {
<a name="l01808"></a>01808     <a class="code" href="rt__CMSIS_8c.html#a25cf234f6d60afd9d5a6e00817a4c38c">rt_clr_box</a>(pool, mem);
<a name="l01809"></a>01809   }
<a name="l01810"></a>01810 
<a name="l01811"></a>01811   <span class="keywordflow">if</span> ((mem == NULL) &amp;&amp; (millisec != 0)) {
<a name="l01812"></a>01812     <span class="comment">// Put Task to sleep when Memory not available</span>
<a name="l01813"></a>01813     <span class="keywordflow">if</span> (pmcb-&gt;p_lnk != NULL) {
<a name="l01814"></a>01814       rt_put_prio((P_XCB)pmcb, os_tsk.run);
<a name="l01815"></a>01815     } <span class="keywordflow">else</span> {
<a name="l01816"></a>01816       pmcb-&gt;p_lnk = os_tsk.run;
<a name="l01817"></a>01817       os_tsk.run-&gt;p_lnk = NULL;
<a name="l01818"></a>01818       os_tsk.run-&gt;p_rlnk = (P_TCB)pmcb;
<a name="l01819"></a>01819       <span class="comment">// Task is waiting to allocate a message</span>
<a name="l01820"></a>01820       pmcb-&gt;state = 3;
<a name="l01821"></a>01821     }
<a name="l01822"></a>01822     rt_block(<a class="code" href="rt__CMSIS_8c.html#aece90d6e1bb87d5b2727ff0a7689984b" title="Convert timeout in millisec to system ticks.">rt_ms2tick</a>(millisec), WAIT_MBX);
<a name="l01823"></a>01823   }
<a name="l01824"></a>01824 
<a name="l01825"></a>01825   <span class="keywordflow">return</span> mem;  
<a name="l01826"></a>01826 }
<a name="l01827"></a>01827 
<a name="l01829"></a><a class="code" href="rt__CMSIS_8c.html#a06c419addafdbdcf29714f73081cf74f">01829</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a06c419addafdbdcf29714f73081cf74f" title="Free a memory block from a mail.">sysMailFree</a> (osMailQId queue_id, <span class="keywordtype">void</span> *mail, uint32_t isr) {
<a name="l01830"></a>01830   P_MCB   pmcb;
<a name="l01831"></a>01831   P_TCB   ptcb;
<a name="l01832"></a>01832   <span class="keywordtype">void</span>   *pool;
<a name="l01833"></a>01833   <span class="keywordtype">void</span>   *mem;
<a name="l01834"></a>01834   int32_t res;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836   <span class="keywordflow">if</span> (queue_id == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01837"></a>01837 
<a name="l01838"></a>01838   pmcb = *(((<span class="keywordtype">void</span> **)queue_id) + 0);
<a name="l01839"></a>01839   pool = *(((<span class="keywordtype">void</span> **)queue_id) + 1);
<a name="l01840"></a>01840 
<a name="l01841"></a>01841   <span class="keywordflow">if</span> ((pmcb == NULL) || (pool == NULL)) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843   res = rt_free_box(pool, mail);
<a name="l01844"></a>01844 
<a name="l01845"></a>01845   <span class="keywordflow">if</span> (res != 0) <span class="keywordflow">return</span> osErrorValue;
<a name="l01846"></a>01846 
<a name="l01847"></a>01847   <span class="keywordflow">if</span> (pmcb-&gt;state == 3) {
<a name="l01848"></a>01848     <span class="comment">// Task is waiting to allocate a message</span>
<a name="l01849"></a>01849     <span class="keywordflow">if</span> (isr) {
<a name="l01850"></a>01850       rt_psq_enq (pmcb, (U32)pool);
<a name="l01851"></a>01851       rt_psh_req ();
<a name="l01852"></a>01852     } <span class="keywordflow">else</span> {
<a name="l01853"></a>01853       mem = rt_alloc_box(pool);
<a name="l01854"></a>01854       <span class="keywordflow">if</span> (mem != NULL) {
<a name="l01855"></a>01855         ptcb = rt_get_first((P_XCB)pmcb);
<a name="l01856"></a>01856         <span class="keywordflow">if</span> (pmcb-&gt;p_lnk == NULL) {
<a name="l01857"></a>01857           pmcb-&gt;state = 0;
<a name="l01858"></a>01858         }
<a name="l01859"></a>01859         rt_ret_val(ptcb, (U32)mem);
<a name="l01860"></a>01860         rt_rmv_dly(ptcb);
<a name="l01861"></a>01861         rt_dispatch(ptcb);
<a name="l01862"></a>01862       }
<a name="l01863"></a>01863     }
<a name="l01864"></a>01864   }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866   <span class="keywordflow">return</span> osOK;
<a name="l01867"></a>01867 }
<a name="l01868"></a>01868 
<a name="l01869"></a>01869 
<a name="l01870"></a>01870 <span class="comment">// Mail Queue Management Public API</span>
<a name="l01871"></a>01871 
<a name="l01873"></a><a class="code" href="rt__CMSIS_8c.html#ae5313fdeb9b8a0791e2affb602a182f0">01873</a> osMailQId <a class="code" href="rt__CMSIS_8c.html#ae5313fdeb9b8a0791e2affb602a182f0" title="Create and Initialize mail queue.">osMailCreate</a> (osMailQDef_t *queue_def, osThreadId thread_id) {
<a name="l01874"></a>01874   <span class="keywordflow">if</span> (__get_IPSR() != 0) <span class="keywordflow">return</span> NULL;           <span class="comment">// Not allowed in ISR</span>
<a name="l01875"></a>01875   <span class="keywordflow">if</span> (((__get_CONTROL() &amp; 1) == 0) &amp;&amp; (os_running == 0)) {
<a name="l01876"></a>01876     <span class="comment">// Privileged and not running</span>
<a name="l01877"></a>01877     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#aa82c01ddb691152284155e93e502e9dc" title="Create and Initialize mail queue.">svcMailCreate</a>(queue_def, thread_id);
<a name="l01878"></a>01878   } <span class="keywordflow">else</span> {
<a name="l01879"></a>01879     <span class="keywordflow">return</span> __svcMailCreate(queue_def, thread_id);
<a name="l01880"></a>01880   }
<a name="l01881"></a>01881 }
<a name="l01882"></a>01882 
<a name="l01884"></a><a class="code" href="rt__CMSIS_8c.html#ac985d7f260b80d7891157697b760aa02">01884</a> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#ac985d7f260b80d7891157697b760aa02" title="Allocate a memory block from a mail.">osMailAlloc</a> (osMailQId queue_id, uint32_t millisec) {
<a name="l01885"></a>01885   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01886"></a>01886     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a3451f199e4795ce3ce8b048bb6a94d24" title="Allocate a memory block from a mail.">sysMailAlloc</a>(queue_id, millisec, 1, 0);
<a name="l01887"></a>01887   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01888"></a>01888     <span class="keywordflow">return</span> __sysMailAlloc(queue_id, millisec, 0, 0);
<a name="l01889"></a>01889   }
<a name="l01890"></a>01890 }
<a name="l01891"></a>01891 
<a name="l01893"></a><a class="code" href="rt__CMSIS_8c.html#a9e492e5839bf0d2bf66492e70eae3ddb">01893</a> <span class="keywordtype">void</span> *<a class="code" href="rt__CMSIS_8c.html#a9e492e5839bf0d2bf66492e70eae3ddb" title="Allocate a memory block from a mail and set memory block to zero.">osMailCAlloc</a> (osMailQId queue_id, uint32_t millisec) {
<a name="l01894"></a>01894   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01895"></a>01895     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a3451f199e4795ce3ce8b048bb6a94d24" title="Allocate a memory block from a mail.">sysMailAlloc</a>(queue_id, millisec, 1, 1);
<a name="l01896"></a>01896   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01897"></a>01897     <span class="keywordflow">return</span> __sysMailAlloc(queue_id, millisec, 0, 1);
<a name="l01898"></a>01898   }
<a name="l01899"></a>01899 }
<a name="l01900"></a>01900 
<a name="l01902"></a><a class="code" href="rt__CMSIS_8c.html#a27c1060cf21393f96b4fd1ed1c0167cc">01902</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a27c1060cf21393f96b4fd1ed1c0167cc" title="Free a memory block from a mail.">osMailFree</a> (osMailQId queue_id, <span class="keywordtype">void</span> *mail) {
<a name="l01903"></a>01903   <span class="keywordflow">if</span> (__get_IPSR() != 0) {                      <span class="comment">// in ISR</span>
<a name="l01904"></a>01904     <span class="keywordflow">return</span>   <a class="code" href="rt__CMSIS_8c.html#a06c419addafdbdcf29714f73081cf74f" title="Free a memory block from a mail.">sysMailFree</a>(queue_id, mail, 1);
<a name="l01905"></a>01905   } <span class="keywordflow">else</span> {                                      <span class="comment">// in Thread</span>
<a name="l01906"></a>01906     <span class="keywordflow">return</span> __sysMailFree(queue_id, mail, 0);
<a name="l01907"></a>01907   }
<a name="l01908"></a>01908 }
<a name="l01909"></a>01909 
<a name="l01911"></a><a class="code" href="rt__CMSIS_8c.html#a485ef6f81854ebda8ffbce4832181e02">01911</a> osStatus <a class="code" href="rt__CMSIS_8c.html#a485ef6f81854ebda8ffbce4832181e02" title="Put a mail to a queue.">osMailPut</a> (osMailQId queue_id, <span class="keywordtype">void</span> *mail) {
<a name="l01912"></a>01912   <span class="keywordflow">if</span> (queue_id == NULL) <span class="keywordflow">return</span> osErrorParameter;
<a name="l01913"></a>01913   <span class="keywordflow">if</span> (mail == NULL)     <span class="keywordflow">return</span> osErrorValue;
<a name="l01914"></a>01914   <span class="keywordflow">return</span> <a class="code" href="rt__CMSIS_8c.html#ac0dcf462fc92de8ffaba6cc004514a6d" title="Put a Message to a Queue.">osMessagePut</a>(*((<span class="keywordtype">void</span> **)queue_id), (uint32_t)mail, 0);
<a name="l01915"></a>01915 }
<a name="l01916"></a>01916 
<a name="l01918"></a><a class="code" href="rt__CMSIS_8c.html#a8eaa5d5d646da098ef170fef2e2e8839">01918</a> os_InRegs osEvent <a class="code" href="rt__CMSIS_8c.html#a8eaa5d5d646da098ef170fef2e2e8839" title="Get a mail from a queue.">osMailGet</a> (osMailQId queue_id, uint32_t millisec) {
<a name="l01919"></a>01919   osEvent ret;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921   <span class="keywordflow">if</span> (queue_id == NULL) {
<a name="l01922"></a>01922     ret.status = osErrorParameter;
<a name="l01923"></a>01923     <span class="keywordflow">return</span> ret;
<a name="l01924"></a>01924   }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926   ret = <a class="code" href="rt__CMSIS_8c.html#adb01ec653d1086f99ba00b4148114ba9" title="Get a Message or Wait for a Message from a Queue.">osMessageGet</a>(*((<span class="keywordtype">void</span> **)queue_id), millisec);
<a name="l01927"></a>01927   <span class="keywordflow">if</span> (ret.status == osEventMessage) ret.status = osEventMail;
<a name="l01928"></a>01928 
<a name="l01929"></a>01929   <span class="keywordflow">return</span> ret;
<a name="l01930"></a>01930 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="rt__CMSIS_8c.html">rt_CMSIS.c</a>      </li>

    <li class="footer">Generated on Thu May 8 2014 21:35:26 for Pandora Head Sensors by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
